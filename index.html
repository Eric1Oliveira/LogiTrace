        
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiTrace - Sistema de Conferência de Cargas</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 100 100&quot;%3E%3Ctext y=&quot;.9em&quot; font-size=&quot;90&quot;%3E%F0%9F%9A%9B%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@zxing/browser@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { 
            font-family: 'Inter', sans-serif; 
        }
        
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            --primary-950: #172554;
            
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }
        
        body {
            background: linear-gradient(135deg, var(--slate-50) 0%, var(--primary-50) 100%);
            min-height: 100vh;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 50%, var(--primary-900) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--slate-200);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            border-color: var(--primary-200);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-pendente { 
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
            color: #92400e; 
            border: 1px solid #f59e0b;
        }
        .status-andamento { 
            background: linear-gradient(135deg, var(--primary-100) 0%, var(--primary-200) 100%); 
            color: var(--primary-800); 
            border: 1px solid var(--primary-300);
        }
        .status-concluido { 
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
            color: #065f46; 
            border: 1px solid #10b981;
        }
        .status-divergente { 
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
            color: #991b1b; 
            border: 1px solid #ef4444;
        }
        
        .nav-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .nav-btn.active {
            color: var(--primary-600) !important;
        }
        
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: 2px 2px 0 0;
        }
        
        .nav-btn:hover:not(.active) {
            color: var(--primary-500) !important;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }
        
        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .kpi-card:hover::before {
            transform: scaleX(1);
        }
        
        .kpi-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 25px 50px rgba(59, 130, 246, 0.2);
            border-color: var(--primary-200);
        }
        
        .notification {
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%) scale(0.8); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(15, 23, 42, 0.6);
            pointer-events: auto !important;
            z-index: 9999;
        }
        
        .input-focus {
            transition: all 0.3s ease;
            border: 2px solid var(--slate-200);
        }
        
        .input-focus:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .header-glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section-title {
            background: linear-gradient(135deg, var(--slate-800) 0%, var(--primary-800) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--primary-400), var(--primary-600));
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .icon-container {
            background: linear-gradient(135deg, var(--primary-100) 0%, var(--primary-200) 100%);
            border: 1px solid var(--primary-300);
        }
        
        .table-row:hover {
            background: linear-gradient(135deg, var(--slate-50) 0%, var(--primary-50) 100%);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--slate-100);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        }
        
        /* Mobile Bottom Navigation */
        .mobile-nav {
            background: rgba(255, 255, 255, 0.95); /* Remova a linha background: transparent; */
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.1);
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 9999 !important;
            display: flex !important;
        }
        
        .mobile-nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            min-width: 60px;
        }
        
        .mobile-nav-item.active {
            color: var(--primary-600);
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
        }
        
        .mobile-nav-item:not(.central-action):active {
            transform: scale(0.95);
        }
        
        .mobile-nav .max-w-sm {
            max-width: 90vw !important;
            width: 90vw !important;
        }
        
        .central-action {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .central-action:hover {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px) scale(1.05);
        }
        
        .central-action:active {
            transform: translateY(0) scale(1);
        }
        
        .mobile-actions-menu {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.15);
            bottom: 120px;
            left: 4px;
            right: 4px;
            z-index: 10000 !important;
            border-radius: 1rem;
            padding: 1.5rem;
            position: fixed;
        }
        
        .action-item {
            transition: all 0.3s ease;
            border-radius: 16px;
        }
        
        .action-item:hover {
            background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }
        
        .action-item:active {
            transform: translateY(0) scale(0.98);
        }
        
        .mobile-search {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid var(--slate-200);
            transition: all 0.3s ease;
        }
        
        .mobile-search:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        /* Animações para o menu de ações */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .mobile-actions-menu.show {
            animation: slideUpFade 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Badge de notificações mobile */
        .mobile-notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        /* Centralizar e animar menu mobile */
        #mobileMenu {
            left: 50% !important;
            right: auto !important;
            transform: translateX(-50%) !important;
            width: 95vw !important;
            min-width: 0 !important;
            max-width: 95vw !important;
            bottom: 120px !important; /* Fica acima do menu inferior e do menu de ações */
            z-index: 10001 !important; /* Maior que o menu de ações */
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            border-radius: 1.5rem;
        }

        #mobileMenu.show {
            transform: translate(-50%, 0) !important;
            opacity: 1;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .desktop-nav {
                display: none !important;
            }
            
            .mobile-only {
                display: block !important;
            }

            .mobile-only.hidden {
                display: none !important;
            }
            
            .mobile-nav {
                display: flex !important;
            }
            
            /* Ajustar padding do conteúdo para o menu inferior */
            #mainSystem .section {
                padding-bottom: 100px;
            }

            #mobileMenu {
            display: block !important;
            }
            #mobileMenu.hidden {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-only {
                display: none !important;
            }
        }

        @media (max-width: 640px) {

            #bipagem .bg-white {
                padding: 1rem !important;
            }
            #bipagem .input-focus {
                font-size: 1rem;
            }
            #bipagem .btn-primary,
            #bipagem .btn-success,
            #bipagem .bg-slate-600 {
                width: 100% !important;
                min-width: 0 !important;
                font-size: 1rem;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            #bipagem .max-h-48 {
                max-height: 220px !important;
            }

            #notificationsPanel {
                top: 6rem !important;
                right: 2rem !important;
                z-index: 2147483647 !important;
                background: #fff;
            }

        }
        
    </style>
</head>
<body class="bg-gray-50">

    <!-- Container para notificações flutuantes -->
    <div id="notifications" style="position: fixed; top: 4.5rem; right: 1.5rem; z-index: 99999; max-width: 90vw;"></div>


    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4" style="position: relative; z-index: 1000;">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md" style="position: relative; z-index: 1001;">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-truck text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">LogiTrace</h1>
                <p class="text-gray-600 mt-2">Sistema de Conferência de Cargas</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="transpo1@gmail.com" required style="position: relative; z-index: 1002;">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" placeholder="Senha123" required style="position: relative; z-index: 1002;">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium" style="position: relative; z-index: 1002; cursor: pointer;">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="hidden">
        <!-- Header -->
        <header class="header-glass shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-truck text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold section-title">LogiTrace</h1>
                            <p class="text-xs text-slate-500 font-medium">Sistema de Conferência</p>
                        </div>
                    </div>
                    
                    <nav class="desktop-nav hidden md:flex space-x-1 bg-slate-100 rounded-xl p-1">
                        <button id="btnDashboard" class="nav-btn active px-6 py-3 text-sm font-semibold rounded-lg transition-all">
                            <i class="fas fa-chart-pie mr-2"></i>Dashboard
                        </button>
                        <button id="btnBipagem" class="nav-btn text-slate-600 px-6 py-3 text-sm font-semibold rounded-lg transition-all">
                            <i class="fas fa-barcode mr-2"></i>Bipagem
                        </button>
                        <button id="btnServicos" class="nav-btn text-slate-600 px-6 py-3 text-sm font-semibold rounded-lg transition-all">
                            <i class="fas fa-boxes mr-2"></i>Serviços
                        </button>
                        <button id="btnRelatorios" class="nav-btn text-slate-600 px-6 py-3 text-sm font-semibold rounded-lg transition-all">
                            <i class="fas fa-chart-bar mr-2"></i>Relatórios
                        </button>
                    </nav>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="mobile-only hidden md:hidden p-3 text-slate-400 hover:text-primary-600 transition-colors rounded-xl hover:bg-primary-50">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        <div class="relative">
                            <button onclick="toggleNotificationsPanel()" class="p-3 text-slate-400 hover:text-primary-600 transition-colors rounded-xl hover:bg-primary-50">
                                <i class="fas fa-bell text-lg"></i>
                                <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden shadow-lg">0</span>
                            </button>
                        </div>
                        <div class="relative">
                            <button onclick="showSection('configuracoes')" class="p-3 text-slate-400 hover:text-primary-600 transition-colors rounded-xl hover:bg-primary-50">
                                <i class="fas fa-cog text-lg"></i>
                            </button>
                        </div>
                        <div class="flex items-center space-x-3 bg-slate-100 rounded-xl px-4 py-2">
                            <div class="w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-sm"></i>
                            </div>
                            <div class="hidden sm:block">
                                <span id="currentUser" class="text-sm font-semibold text-slate-700 max-w-[120px] truncate inline-block align-middle overflow-hidden" title="Usuário conectado"></span>
                                <p class="text-xs text-slate-500">Usuário ativo</p>
                            </div>
                            <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition-colors ml-2">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Configurações -->
        <div id="configuracoes" class="section hidden">
            <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-user-cog text-blue-500"></i> Configurações de Perfil
                    </h2>
                    <p class="text-gray-600">Veja e atualize suas informações pessoais.</p>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-8 mb-8">

                    <div class="space-y-4">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-500 text-2xl"></i>
                            </div>
                            <div>
                                <div class="text-xl font-bold text-gray-900" id="perfilNome">Usuário</div>
                                <div class="text-sm text-gray-500" id="perfilEmail">email@email.com</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Trocar Senha</h3>
                    <form id="formTrocarSenha" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Senha Atual</label>
                            <input type="password" id="senhaAtual" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nova Senha</label>
                            <input type="password" id="novaSenha" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nova Senha</label>
                            <input type="password" id="confirmarNovaSenha" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold transition">Trocar Senha</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Painel de Notificações -->
        <div id="notificationsPanel" class="absolute z-[2147483647] hidden" style="min-width: 320px; max-width: 90vw; pointer-events: auto; top: 5,5rem; right: 22rem; z-index:2147483647;">
            <div class="w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-[2147483647]" style="z-index: 2147483647; pointer-events: auto;">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <div class="flex items-center justify-between w-full">
                        <h3 class="font-semibold text-gray-900">Notificações</h3>
                        <button onclick="clearAllNotifications()" title="Limpar todas as notificações" class="ml-auto bg-red-100 hover:bg-red-200 text-red-600 rounded-full p-2 shadow transition duration-200 flex items-center justify-center">
                            <i class="fas fa-trash-alt" style="font-size: 1.2rem;"></i>
                        </button>
                    </div>
                </div>
                <div id="notificationsList" class="max-h-96 overflow-y-auto">
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-3xl mb-3 opacity-50"></i>
                        <p>Nenhuma notificação</p>
                    </div>
                </div>
                <div class="p-3 border-t border-gray-100 text-center">
                    <button onclick="toggleNotificationsPanel()" class="text-sm text-gray-600 hover:text-gray-800">
                        Fechar
                    </button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="mb-12">
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="icon-container p-4 rounded-2xl shadow-lg">
                            <i class="fas fa-chart-pie text-primary-600 text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-4xl font-bold section-title">Dashboard</h2>
                            <p class="text-slate-600 text-lg font-medium">Visão geral do sistema em tempo real</p>
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
                    <div class="kpi-card rounded-2xl shadow-xl p-8 group" onclick="abrirModalKPI('servicos-ativos')">
                        <div class="flex items-center justify-between mb-6">
                            <div class="icon-container p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-tasks text-primary-600 text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Serviços Ativos</p>
                                <p id="servicosAtivos" class="text-4xl font-bold text-slate-800 mt-1">0</p>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="bg-slate-200 rounded-full h-3 overflow-hidden">
                                <div id="progressoAtivos" class="progress-bar h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500 font-medium">Progresso geral</span>
                            <span class="text-primary-600 font-semibold">Em andamento</span>
                        </div>
                    </div>

                    <div class="kpi-card rounded-2xl shadow-xl p-8 group" onclick="abrirModalKPI('concluidos-hoje')">
                        <div class="flex items-center justify-between mb-6">
                            <div class="bg-gradient-to-br from-emerald-100 to-emerald-200 border border-emerald-300 p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-check-circle text-emerald-600 text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Concluídos Hoje</p>
                                <p id="concluidosHoje" class="text-4xl font-bold text-slate-800 mt-1">0</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500 font-medium">Finalizados hoje</span>
                            <span class="text-emerald-600 font-semibold">+0% vs ontem</span>
                        </div>
                    </div>

                    <div class="kpi-card rounded-2xl shadow-xl p-8 group" onclick="abrirModalKPI('divergencias')">
                        <div class="flex items-center justify-between mb-6">
                            <div class="bg-gradient-to-br from-red-100 to-red-200 border border-red-300 p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Divergências</p>
                                <p id="divergenciasTotal" class="text-4xl font-bold text-slate-800 mt-1">0</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500 font-medium">Problemas detectados</span>
                            <span class="text-red-600 font-semibold">Requer atenção</span>
                        </div>
                    </div>

                    <div class="kpi-card rounded-2xl shadow-xl p-8 group" onclick="abrirModalKPI('tempo-medio')">
                        <div class="flex items-center justify-between mb-6">
                            <div class="bg-gradient-to-br from-amber-100 to-amber-200 border border-amber-300 p-4 rounded-2xl shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-clock text-amber-600 text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Tempo Médio</p>
                                <p id="tempoMedio" class="text-4xl font-bold text-slate-800 mt-1">0min</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-slate-500 font-medium">Performance média</span>
                            <span class="text-amber-600 font-semibold">Otimizado</span>
                        </div>
                    </div>
                </div>

                <!-- Gráficos e Atividade -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card rounded-2xl shadow-xl p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold section-title">Status dos Serviços</h3>
                                <p class="text-sm text-slate-500 mt-1">Distribuição atual por status</p>
                            </div>
                            <div class="icon-container p-3 rounded-xl">
                                <i class="fas fa-chart-pie text-primary-600"></i>
                            </div>
                        </div>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl shadow-xl p-8">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-bold section-title">Atividade Recente</h3>
                                <p class="text-sm text-slate-500 mt-1">Últimas atualizações do sistema</p>
                            </div>
                            <div class="icon-container p-3 rounded-xl">
                                <i class="fas fa-history text-primary-600"></i>
                            </div>
                        </div>
                        <div id="atividadeRecente" class="space-y-4 max-h-64 overflow-y-auto custom-scrollbar">
                            <!-- Atividades serão inseridas aqui -->
                        </div>
                    </div>
                </div>


            </div>
        </div>

        <!-- Sistema de Bipagem -->
        <div id="bipagem" class="section hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8">
                    <h2 class="text-2xl sm:text-3xl font-bold text-blue-900 flex items-center gap-3">
                        <i class="fas fa-barcode text-blue-500"></i> Sistema de Bipagem
                    </h2>
                    <p class="text-blue-700 text-base sm:text-lg">Escaneamento e registro de itens para transporte</p>
                </div>

                <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 rounded-2xl shadow-lg p-8 border border-blue-100">
                    <!-- Configuração da Rota -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-truck text-blue-400"></i> Transportadora Origem
                            </label>
                            <select id="origemSelect" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm" onchange="atualizarDestinoAuto()">
                                <option value="">Selecione a origem</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-truck-moving text-blue-400"></i> Transportadora Destino
                            </label>
                            <select id="destinoSelect" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm" onchange="atualizarOrigemAuto()">
                                <option value="">Selecione o destino</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campo de Bipagem -->
                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-blue-700 mb-3 flex items-center gap-2">
                            <i class="fas fa-barcode text-blue-400"></i> Código de Barras
                        </label>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="text" id="codigoBarras" class="flex-1 px-4 py-3 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm" placeholder="Escaneie ou digite o código">
                            <button onclick="adicionarItem()" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white px-6 py-3 rounded-xl shadow-md hover:from-blue-600 hover:to-blue-800 transition-all font-semibold text-base flex items-center justify-center gap-2 w-full sm:w-auto">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                            <button type="button" onclick="abrirScannerZXing('codigoBarras')" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-6 py-3 rounded-xl shadow-md hover:from-green-600 hover:to-green-800 transition-all font-semibold text-base flex items-center justify-center gap-2 w-full sm:w-auto">
                                <i class="fas fa-camera"></i> Bipar pela Câmera
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Itens -->
                    <div class="mb-8">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
                            <h3 class="text-lg font-semibold text-blue-900 flex items-center gap-2">
                                <i class="fas fa-list text-blue-400"></i> Itens Bipados
                            </h3>
                            <span id="contadorItens" class="bg-blue-100 text-blue-800 px-4 py-1 rounded-full text-base font-semibold">0 itens</span>
                        </div>
                        <div id="listaItens" class="space-y-2 max-h-56 sm:max-h-72 overflow-y-auto bg-white rounded-xl p-4 border border-blue-100 shadow-sm">
                            <!-- Itens serão inseridos aqui -->
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="criarServico()" class="bg-gradient-to-r from-green-500 to-green-700 text-white px-6 py-3 rounded-xl shadow-md hover:from-green-600 hover:to-green-800 transition-all font-semibold text-base flex items-center justify-center gap-2 w-full sm:w-auto">
                            <i class="fas fa-save"></i> Criar Serviço
                        </button>
                        <button onclick="limparBipagem()" class="bg-gradient-to-r from-gray-600 to-gray-800 text-white px-6 py-3 rounded-xl shadow-md hover:from-gray-700 hover:to-gray-900 transition-all font-semibold text-base flex items-center justify-center gap-2 w-full sm:w-auto">
                            <i class="fas fa-trash"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gerenciamento de Serviços -->
        <div id="servicos" class="section hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Gerenciamento de Serviços</h2>
                            <p class="text-gray-600">Controle e acompanhamento de todos os serviços</p>
                        </div>
                        <button onclick="showSection('bipagem')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Novo Serviço
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 rounded-2xl shadow-lg p-8 mb-8 border border-blue-100">
                    <div class="flex flex-col md:flex-row md:items-end md:space-x-6 space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-tasks text-blue-400"></i> Status
                            </label>
                            <select id="filtroStatus" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                                <option value="">Todos os Status</option>
                                <option value="pendente">Pendente</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="concluido">Concluído</option>
                                <option value="divergente">Divergente</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-truck text-blue-400"></i> Transportadora
                            </label>
                            <select id="filtroTransportadora" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                                <option value="">Todas as Transportadoras</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-calendar-alt text-blue-400"></i> Data
                            </label>
                            <input type="date" id="filtroData" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                        </div>
                        <div class="flex-1 flex items-end">
                            <button onclick="limparFiltros()" class="w-full bg-gradient-to-r from-gray-600 to-gray-800 text-white px-6 py-3 rounded-xl shadow-md hover:from-gray-700 hover:to-gray-900 transition-all font-semibold text-base flex items-center justify-center gap-2">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grid de Serviços -->
                <div id="gridServicos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Serviços serão inseridos aqui -->
                </div>
            </div>
        </div>



        <!-- Relatórios -->
        <div id="relatorios" class="section hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900">Relatórios e Análises</h2>
                    <p class="text-gray-600">Análise detalhada de performance e histórico</p>
                </div>

                <!-- Filtros de Período -->
                <div class="bg-gradient-to-br from-blue-50 via-white to-blue-100 rounded-2xl shadow-lg p-8 mb-8 border border-blue-100">
                    <div class="flex flex-col md:flex-row md:items-end md:space-x-6 space-y-4 md:space-y-0">
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-calendar-alt text-blue-400"></i> Data Início
                            </label>
                            <input type="date" id="dataInicio" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-calendar-day text-blue-400"></i> Data Fim
                            </label>
                            <input type="date" id="dataFim" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-file-alt text-blue-400"></i> Tipo de Relatório
                            </label>
                            <select id="tipoRelatorio" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                                <option value="geral">Relatório Geral</option>
                                <option value="divergencias">Apenas Divergências</option>
                                <option value="performance">Performance</option>
                                <option value="transportadoras">Por Transportadora</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold text-blue-700 mb-2 flex items-center gap-2">
                                <i class="fas fa-truck text-blue-400"></i> Transportadora
                            </label>
                            <select id="filtroRelatorioTransportadora" class="w-full px-4 py-2 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-400 bg-white shadow-sm">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="flex-1 flex items-end">
                            <button onclick="gerarRelatorioCompleto()" class="w-full bg-gradient-to-r from-blue-500 to-blue-700 text-white px-6 py-3 rounded-xl shadow-md hover:from-blue-600 hover:to-blue-800 transition-all font-semibold text-base flex items-center justify-center gap-2">
                                <i class="fas fa-chart-bar"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KPIs do Período -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg">
                                <i class="fas fa-clipboard-list text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total de Serviços</p>
                                <p id="relatorioTotalServicos" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-lg">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Taxa de Sucesso</p>
                                <p id="relatorioTaxaSucesso" class="text-2xl font-bold text-gray-900">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-red-100 p-3 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Divergências</p>
                                <p id="relatorioTotalDivergencias" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <i class="fas fa-clock text-yellow-600"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Tempo Médio</p>
                                <p id="relatorioTempoMedio" class="text-2xl font-bold text-gray-900">0min</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Taxa de Sucesso por Período</h3>
                        <div class="h-64">
                            <canvas id="sucessoChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Serviços por Status</h3>
                        <div class="h-64">
                            <canvas id="statusRelatorioChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Volume por Transportadora</h3>
                        <div class="h-64">
                            <canvas id="transportadoraChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Evolução Mensal</h3>
                        <div class="h-64">
                            <canvas id="mensalChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ranking e Análises -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Top Transportadoras</h3>
                        <div id="topTransportadoras" class="space-y-3">
                            <!-- Lista será inserida aqui -->
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Análise de Divergências</h3>
                        <div id="analiseDivergencias" class="space-y-3">
                            <!-- Análise será inserida aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tabela de Serviços Detalhada -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Histórico Detalhado</h3>
                        <div class="flex space-x-2">
                            <button onclick="exportarCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-file-csv mr-1"></i>Exportar CSV
                            </button>
                            <button onclick="gerarPDFRelatorioCompleto()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                <i class="fas fa-file-pdf mr-1"></i>Exportar PDF
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Serviço</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Origem</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destino</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Divergências</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaHistorico" class="bg-white divide-y divide-gray-200">
                                <!-- Dados serão inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav mobile-only fixed bottom-0 left-0 right-0 z-40">
            <div class="flex items-center justify-center py-3 px-6">
                <div class="flex items-center justify-between w-full max-w-sm bg-white rounded-2xl shadow-2xl px-4 py-2">
                    <!-- Dashboard -->
                    <button onclick="showSection('dashboard')" class="mobile-nav-item flex flex-col items-center py-3 px-2 text-slate-600 rounded-xl transition-all" id="mobileBtnDashboard">
                        <i class="fas fa-chart-pie text-[17px] mb-1"></i>
                        <span class="text-xs font-medium">Home</span>
                    </button>
                    <!-- Bipagem -->
                    <button onclick="showSection('bipagem')" class="mobile-nav-item flex flex-col items-center py-3 px-2 text-slate-600 rounded-xl transition-all" id="mobileBtnBipagem">
                        <i class="fas fa-barcode text-[15px] mb-1"></i>
                        <span class="text-xs font-medium">Bipar</span>
                    </button>
                    <!-- Central Action Button -->
                    <button onclick="toggleMobileActionsMenu()" class="central-action w-14 h-14 rounded-2xl text-white flex items-center justify-center -mt-4 shadow-2xl">
                        <i class="fas fa-plus text-[19px]" id="centralActionIcon"></i>
                    </button>
                    <!-- Serviços -->
                    <button onclick="showSection('servicos')" class="mobile-nav-item flex flex-col items-center py-3 px-2 text-slate-600 rounded-xl transition-all" id="mobileBtnServicos">
                        <div class="relative">
                            <i class="fas fa-boxes text-[14px] mb-1"></i>
                            <span id="mobileServicosBadge" class="mobile-notification-badge hidden">0</span>
                        </div>
                        <span class="text-xs font-medium">Serviços</span>
                    </button>
                    <!-- Menu -->
                    <button onclick="toggleMobileMenu()" class="mobile-nav-item flex flex-col items-center py-3 px-2 text-slate-600 rounded-xl transition-all">
                        <div class="relative">
                            <i class="fas fa-user text-[13px] mb-1"></i>
                        </div>
                        <span class="text-xs font-medium">Perfil</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Actions Menu -->
        <div id="mobileActionsMenu" class="mobile-actions-menu fixed left-4 right-4 z-[10000] rounded-2xl p-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-900">Central de Ações</h3>
                <button onclick="toggleMobileActionsMenu()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="mobileSearchInput" class="mobile-search w-full px-4 py-3 pl-12 rounded-xl" placeholder="Buscar serviço, código...">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Quick Actions Grid -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Nova Bipagem -->
                <button onclick="showSection('bipagem'); toggleMobileActionsMenu();" class="action-item p-4 text-center">
                    <div class="bg-blue-100 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-barcode text-blue-600 text-xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-900">Nova Bipagem</p>
                    <p class="text-xs text-gray-500">Escanear itens</p>
                </button>
                
                <!-- Conferência Rápida -->
                <button onclick="abrirConferenciaRapida()" class="action-item p-4 text-center">
                    <div class="bg-green-100 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-check-double text-green-600 text-xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-900">Conferência</p>
                    <p class="text-xs text-gray-500">Verificar itens</p>
                </button>
                
                <!-- Buscar Serviço -->
                <button onclick="abrirBuscaServico()" class="action-item p-4 text-center">
                    <div class="bg-purple-100 w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-search text-purple-600 text-xl"></i>
                    </div>
                    <p class="text-sm font-semibold text-gray-900">Buscar</p>
                    <p class="text-xs text-gray-500">Localizar serviço</p>
                </button>
            
            </div>
            
            <!-- Status Overview -->
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">Status Atual</h4>
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div>
                        <p class="text-lg font-bold text-blue-600" id="mobileStatusAtivos">0</p>
                        <p class="text-xs text-gray-600">Ativos</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-green-600" id="mobileStatusConcluidos">0</p>
                        <p class="text-xs text-gray-600">Concluídos</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-red-600" id="mobileStatusDivergencias">0</p>
                        <p class="text-xs text-gray-600">Divergências</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Profile Menu -->
        <div id="mobileMenu" class="mobile-only fixed bottom-24 w-72 bg-white z-50 transform translate-y-full transition-transform duration-300 shadow-2xl rounded-2xl hidden">
            <div class="p-6">
                <!-- User Info -->
                <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-4 mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900" id="mobileCurrentUser">Usuário</p>
                            <p class="text-sm text-gray-500">Operador ativo</p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="space-y-3 mb-6">
                    <button onclick="showSection('relatorios'); toggleMobileMenu();" class="w-full flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-50 transition-colors">
                        <i class="fas fa-chart-bar text-orange-600 w-5"></i>
                        <span class="font-medium text-gray-900">Relatórios</span>
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <h4 class="font-semibold text-gray-900 mb-3">Status Atual</h4>
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div>
                            <p class="text-lg font-bold text-blue-600" id="mobileQuickStatsAtivos">0</p>
                            <p class="text-xs text-gray-600">Ativos</p>
                        </div>
                        <div>
                            <p class="text-lg font-bold text-green-600" id="mobileQuickStatsHoje">0</p>
                            <p class="text-xs text-gray-600">Hoje</p>
                        </div>
                    </div>
                </div>
                
                <!-- Logout -->
                <button onclick="showSection('configuracoes'); document.getElementById('mobileMenu').classList.add('hidden');" class="w-full flex items-center justify-center space-x-2 p-3 bg-blue-50 text-blue-700 rounded-xl hover:bg-blue-100 transition-colors mb-2">
                    <i class="fas fa-key"></i>
                    <span class="font-medium">Trocar Senha</span>
                </button>
                <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 p-3 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="font-medium">Sair do Sistema</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro de Transportadora -->
    <div id="modalTransportadora" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-900">Cadastrar Transportadora</h3>
                        <button onclick="fecharModalTransportadora()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="formTransportadora" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Transportadora</label>
                            <input type="text" id="nomeTransportadora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: TransLog Express" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">CNPJ</label>
                            <input type="text" id="cnpjTransportadora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="00.000.000/0000-00" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input type="text" id="telefoneTransportadora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="emailTransportadora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="contato@transportadora.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                            <textarea id="enderecoTransportadora" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="2" placeholder="Rua, número, bairro - Cidade/UF"></textarea>
                        </div>
                        
                        <div class="flex space-x-4 pt-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-all">
                                <i class="fas fa-save mr-2"></i>Cadastrar
                            </button>
                            <button type="button" onclick="fecharModalTransportadora()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-all">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Conferência -->
    <div id="modalConferencia" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50" style="pointer-events: auto;">
        <div class="flex items-center justify-center min-h-screen p-4" style="pointer-events: none;">
            <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto" style="pointer-events: auto;">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-900">Conferência de Recebimento</h3>
                        <button onclick="fecharModalConferencia()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <p id="infoServico" class="text-gray-600 mt-2"></p>
                </div>
                
                <div class="p-6">
                    <!-- Campo de Bipagem -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bipar Item Recebido</label>
                        <div class="flex space-x-2">
                            <input type="text" id="codigoConferencia" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Escaneie o código do item recebido">
                            <button onclick="conferirItem()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Conferir
                            </button>
                            <button type="button" onclick="abrirScannerZXing('codigoConferencia')" class="bg-gradient-to-r from-blue-500 to-blue-700 text-white px-6 py-2 rounded-lg shadow-md hover:from-blue-600 hover:to-blue-800 transition-all font-semibold text-base flex items-center justify-center gap-2">
                                <i class="fas fa-camera"></i> Bipar pela Câmera
                            </button>
                        </div>
                    </div>

                    <!-- Contadores -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-blue-600" id="totalEnviados">0</p>
                            <p class="text-sm text-gray-600">Enviados</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-600" id="totalRecebidos">0</p>
                            <p class="text-sm text-gray-600">Recebidos</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-red-600" id="totalDivergencias">0</p>
                            <p class="text-sm text-gray-600">Divergências</p>
                        </div>
                    </div>

                    <!-- Listas de Comparação -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Itens Enviados</h4>
                            <div id="listaEnviados" class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-3">
                                <!-- Lista será inserida aqui -->
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Itens Recebidos</h4>
                            <div id="listaRecebidos" class="space-y-2 max-h-64 overflow-y-auto border rounded-lg p-3">
                                <!-- Lista será inserida aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de Divergências -->
                    <div id="alertaDivergencias" class="mt-6 hidden">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-red-800">Divergências Detectadas</h4>
                                    <p class="text-sm text-red-600" id="mensagemDivergencias">Foram encontradas divergências na conferência</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="flex justify-end space-x-4 mt-6 pt-6 border-t">
                        <button onclick="finalizarConferencia()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Finalizar Conferência
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Conclusão com Comentário -->
    <div id="modalConclusao" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-[10000]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-900">Concluir Serviço</h3>
                        <button onclick="fecharModalConclusao()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="mb-6">
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-orange-600 text-xl mr-3"></i>
                                <div>
                                    <h4 class="font-semibold text-orange-800">Atenção</h4>
                                    <p class="text-sm text-orange-700">Este serviço possui divergências. Adicione um comentário explicando a conclusão.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="infoConclusaoServico" class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <!-- Informações do serviço serão inseridas aqui -->
                        </div>
                        
                        <label class="block text-sm font-medium text-gray-700 mb-2">Comentário da Conclusão *</label>
                        <textarea id="comentarioConclusao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 resize-none" rows="4" placeholder="Descreva o motivo da conclusão mesmo com divergências..." required></textarea>
                        <p class="text-xs text-gray-500 mt-1">Este comentário será registrado no histórico do serviço</p>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button onclick="confirmarConclusaoComDivergencia()" class="flex-1 bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-all font-medium">
                            <i class="fas fa-check mr-2"></i>Confirmar Conclusão
                        </button>
                        <button onclick="fecharModalConclusao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-all font-medium">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalScannerZXing" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[99999] hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 flex flex-col items-center">
            <h3 class="text-lg font-bold text-gray-900 mb-2">Escaneie o Código de Barras</h3>
            <video id="videoScannerZXing" style="width:320px; height:240px; border-radius:12px; background:#222;" autoplay></video>
            <button onclick="fecharScannerZXing()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>

    <script>

        // Função global para preencher dados do perfil do usuário
        function preencherPerfilUsuario() {
            // Busca o usuário logado do localStorage se não estiver em memória
            if (!currentUser) {
                const usuarioSalvo = localStorage.getItem('logitrace_user');
                if (usuarioSalvo) {
                    const parsed = JSON.parse(usuarioSalvo);
                    // Garante que id e grupo_id estão presentes
                    currentUser = {
                        id: parsed.id || null,
                        email: parsed.email || '',
                        nome: parsed.nome || '',
                        grupo_id: parsed.grupo_id || null
                    };
                }
            }
            if (currentUser) {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = currentUser.nome || '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = currentUser.email || '';
                }
            } else {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = '';
                }
            }
        }

        const supabaseClient = supabase.createClient('https://xjjlbewjyhtcavfjstmq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqamxiZXdqeWh0Y2F2ZmpzdG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1Njg0MTEsImV4cCI6MjA3MTE0NDQxMX0.a8nTYe2HEUcu_QJTKMJd6DX701QQycAUDY-JqlT16xU');

        // Sistema de dados simulado (em produção seria Supabase)
        let currentUser = null;
        let notificacoesSistema = [];
        let transportadoras = [
            {
                id: 'b3e7c2d0-1234-4abc-9def-123456789abc',
                nome: 'Transpo SP',
                cnpj: '11.222.333/0001-44',
                telefone: '(11) 98765-4321',
                email: 'contato@transposp.com.br',
                endereco: 'Av. Paulista, 1000 - São Paulo/SP',
                status: 'ativo'
            },
            {
                id: 'c4f8d3e1-5678-4def-8abc-987654321def',
                nome: 'Transpo BA',
                cnpj: '22.333.444/0001-55',
                telefone: '(71) 99876-5432',
                email: 'contato@transpoba.com.br',
                endereco: 'Av. Tancredo Neves, 500 - Salvador/BA',
                status: 'ativo'
            }
        ];
        let servicos = [];
        let itensBipagem = [];
        let servicoAtualConferencia = null;
        let itensRecebidos = [];
        let atividades = [];

        // Usuários válidos
        const usuarios = {
            'transpo1@gmail.com': { senha: 'Senha123', nome: 'Transportadora 1' },
            'transpo2@gmail.com': { senha: 'Senha123', nome: 'Transportadora 2' }
        };

        // Sistema de Login com persistência
        function preencherLogin(email, senha) {
            document.getElementById('loginEmail').value = email;
            document.getElementById('loginPassword').value = senha;
        }

        // Verificar se há usuário logado ao carregar a página
        function verificarUsuarioLogado() {

        // Função global para preencher dados do perfil do usuário
        function preencherPerfilUsuario() {
            // Busca o usuário logado do localStorage se não estiver em memória
            if (!currentUser) {
                const usuarioSalvo = localStorage.getItem('logitrace_user');
                if (usuarioSalvo) {
                    const parsed = JSON.parse(usuarioSalvo);
                    // Garante que id e grupo_id estão presentes
                    currentUser = {
                        id: parsed.id || null,
                        email: parsed.email || '',
                        nome: parsed.nome || '',
                        grupo_id: parsed.grupo_id || null
                    };
                }
            }
            if (currentUser) {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = currentUser.nome || '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = currentUser.email || '';
                }
            } else {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = '';
                }
            }
                }
            }
            if (currentUser) {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = currentUser.nome || '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = currentUser.email || '';
                }
            } else {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = '';
                }
            }

        function showSection(section) {
            // Esconde todas as seções
            document.querySelectorAll('.section').forEach(function(sec) {
                sec.classList.add('hidden');
            });
            // Mostra a seção desejada
            const el = document.getElementById(section);
            if (el) {
                el.classList.remove('hidden'); 
            }

        window.showSection = showSection;
            const usuarioSalvo = localStorage.getItem('logitrace_user');
            if (usuarioSalvo) {
                currentUser = JSON.parse(usuarioSalvo);
                document.getElementById('currentUser').textContent = currentUser.nome;
                // Corrigir exibição do nome do usuário na versão mobile
                if (document.getElementById('mobileCurrentUser')) {
                    document.getElementById('mobileCurrentUser').textContent = currentUser.nome;
                }
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainSystem').classList.remove('hidden');
                preencherPerfilUsuario();
                inicializarSistema();
                return true;
            }
            return false;
        }

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginPassword').value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: senha });
            if (error || !data || !data.user || !data.user.id) {
                showNotification('Credenciais inválidas ou erro ao obter ID do usuário!', 'error');
                return;
            }

            // Buscar perfil do usuário na tabela 'usuarios'
            const { data: perfil, error: perfilError } = await supabaseClient
                .from('usuarios')
                .select('id, nome, grupo_id, email')
                .eq('id', data.user.id)
                .single();

            if (perfilError || !perfil) {
                showNotification('Perfil não encontrado!', 'error');
                return;
            }

            if (!perfil.grupo_id) {
                showNotification('Erro: usuário sem grupo definido! Solicite ao administrador para configurar o grupo.', 'error');
                return;
            }

            currentUser = { 
                id: perfil.id, 
                email: perfil.email, 
                nome: perfil.nome, 
                grupo_id: perfil.grupo_id 
            };

            // Atualizar grupo_id e display_name no metadata do usuário (JWT claim)
            await supabaseClient.auth.updateUser({
                data: { grupo_id: perfil.grupo_id, display_name: perfil.nome }
            });
            localStorage.setItem('logitrace_user', JSON.stringify(currentUser));
            document.getElementById('currentUser').textContent = currentUser.nome;
            if (document.getElementById('mobileCurrentUser')) {
                document.getElementById('mobileCurrentUser').textContent = currentUser.nome;
            }
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainSystem').classList.remove('hidden');
            preencherPerfilUsuario();
            inicializarSistema();
            showNotification('Login realizado com sucesso! Bem-vindo ao LogiTrace!', 'success');
        });

        function logout() {
            currentUser = null;
            localStorage.removeItem('logitrace_user');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // Sistema de Notificações
        function toggleNotificationsPanel() {
            const panel = document.getElementById('notificationsPanel');
            const backdrop = document.getElementById('notificationsBackdrop');
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) {
                atualizarPainelNotificacoes();
                panel.classList.remove('hidden');
                if (backdrop) backdrop.style.display = 'block';
                // Fechar ao clicar fora
                setTimeout(() => {
                    document.addEventListener('click', fecharPainelNotificacoes);
                }, 100);
            } else {
                panel.classList.add('hidden');
                if (backdrop) backdrop.style.display = 'none';
                document.removeEventListener('click', fecharPainelNotificacoes);
            }
        }

        let zxingCodeReader = null;
        let zxingScannerActive = false;
        let zxingCurrentInput = null;

        // Função para abrir o scanner
        function abrirScannerZXing(inputId) {
            if (!window.ZXing || !window.ZXing.BrowserBarcodeReader) {
                showNotification('ZXing Barcode Reader não carregado!', 'error');
                return;
            }
            zxingCurrentInput = inputId;
            document.getElementById('modalScannerZXing').classList.remove('hidden');
            const video = document.getElementById('videoScannerZXing');
            if (!zxingCodeReader) {
                zxingCodeReader = new window.ZXing.BrowserBarcodeReader();
            }
            zxingScannerActive = true;
            zxingCodeReader.decodeOnceFromVideoDevice(undefined, video)
                .then(result => {
                    if (result && result.text) {
                        document.getElementById(zxingCurrentInput).value = result.text;
                        showNotification('Código bipado: ' + result.text, 'success');
                        fecharScannerZXing();
                    }
                })
                .catch(err => {
                    showNotification('Erro ao bipar: ' + err, 'error');
                    fecharScannerZXing();
                });
        }

        // Função para fechar o scanner
        function fecharScannerZXing() {
            document.getElementById('modalScannerZXing').classList.add('hidden');
            if (zxingCodeReader && zxingScannerActive) {
                zxingCodeReader.reset();
                zxingScannerActive = false;
            }
        }

        // Troca de senha via configurações
        document.getElementById('formTrocarSenha').addEventListener('submit', async function(e) {
            e.preventDefault();
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;

            if (!currentUser || !currentUser.email) {
                showNotification('Usuário não autenticado. Faça login novamente.', 'error');
                return;
            }
            if (!senhaAtual || !novaSenha || !confirmarNovaSenha) {
                showNotification('Preencha todos os campos!', 'warning');
                return;
            }
            if (novaSenha !== confirmarNovaSenha) {
                showNotification('Nova senha e confirmação não conferem!', 'warning');
                return;
            }
            if (novaSenha.length < 6) {
                showNotification('A nova senha deve ter pelo menos 6 caracteres!', 'warning');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: currentUser.email,
                    password: senhaAtual
                });
                if (error || !data || !data.user) {
                    showNotification('Senha atual incorreta!', 'error');
                    return;
                }

                const { error: updateError } = await supabaseClient.auth.updateUser({
                    password: novaSenha
                });
                if (updateError) {
                    showNotification('Erro ao trocar senha: ' + updateError.message, 'error');
                    return;
                }

                showNotification('Senha alterada com sucesso!', 'success');
                document.getElementById('formTrocarSenha').reset();
            } catch (err) {
                showNotification('Erro inesperado ao trocar senha!', 'error');
            }
        });

        function fecharPainelNotificacoes(event) {
            const panel = document.getElementById('notificationsPanel');
            const backdrop = document.getElementById('notificationsBackdrop');
            const button = event.target.closest('button[onclick="toggleNotificationsPanel()"]');
            if ((backdrop && event.target === backdrop) || (!panel.contains(event.target) && !button)) {
                panel.classList.add('hidden');
                if (backdrop) backdrop.style.display = 'none';
                document.removeEventListener('click', fecharPainelNotificacoes);
            }
        }

        async function carregarNotificacoesSupabase() {
            if (currentUser && currentUser.id) {
                const { data, error } = await supabaseClient
                    .from('notificacoes')
                    .select('*')
                    .eq('usuario_id', currentUser.id)
                    .order('created_at', { ascending: false });
                notificacoesSistema = data || [];
                atualizarBadgeNotificacoes();
                atualizarPainelNotificacoes();
            } else {
                notificacoesSistema = [];
                atualizarBadgeNotificacoes();
                atualizarPainelNotificacoes();
            }
        } 

        async function adicionarNotificacaoSistema(grupoId, mensagem, tipo = 'info', acao = null) {
            if (!grupoId) return;
            // Buscar todos os usuários do grupo, garantindo que grupo_id está presente
            const { data: usuariosGrupo, error } = await supabaseClient
                .from('usuarios')
                .select('id, grupo_id')
                .eq('grupo_id', grupoId);
            if (error || !usuariosGrupo) return;
            for (const usuario of usuariosGrupo) {
                await supabaseClient
                    .from('notificacoes')
                    .insert({
                        usuario_id: usuario.id,
                        grupo_id: usuario.grupo_id || grupoId,
                        titulo: 'Notificação do Sistema',
                        mensagem: mensagem,
                        tipo: tipo,
                        lida: false,
                        acao: acao,
                        data_leitura: null,
                        created_at: new Date().toISOString()
                    });
            }
            carregarNotificacoesSupabase();
        }

        function atualizarPainelNotificacoes() {
            const lista = document.getElementById('notificationsList');
            lista.innerHTML = notificacoesSistema.map(notif => `
                <div class="p-4 border-b border-gray-100 hover:bg-gray-50 ${!notif.lida ? 'bg-blue-50' : ''}" onclick="marcarComoLida(${notif.id})">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 mt-1">
                            <i class="fas ${getIconeNotificacao(notif.tipo)} ${getCorNotificacao(notif.tipo)}"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 ${!notif.lida ? 'font-bold' : ''}">${notif.titulo}</p>
                            <p class="text-xs text-gray-600 mt-1">${notif.mensagem}</p>
                            <p class="text-xs text-gray-400 mt-2">${formatarTempoRelativo(notif.dataHora)}</p>
                        </div>
                        ${!notif.lida ? '<div class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0 mt-2"></div>' : ''}
                    </div>
                    ${notif.acao ? `
                        <div class="mt-3 pl-6">
                            <button onclick="executarAcaoNotificacao('${notif.acao}', ${notif.id})" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700">
                                Ver detalhes
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function atualizarBadgeNotificacoes() {
            const badge = document.getElementById('notificationBadge');
            const naoLidas = notificacoesSistema.filter(n => !n.lida).length;
            
            if (naoLidas > 0) {
                badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function marcarComoLida(id) {
            const notificacao = notificacoesSistema.find(n => n.id === id);
            if (notificacao) {
                supabaseClient
                    .from('notificacoes')
                    .update({ lida: true, data_leitura: new Date().toISOString() })
                    .eq('id', notificacao.id)
                    .then(({ error }) => {
                        if (!error) {
                            notificacao.lida = true;
                            atualizarBadgeNotificacoes();
                            atualizarPainelNotificacoes();
                        }
                    });
            }
        }
        function clearAllNotifications() {
            if (currentUser && currentUser.grupo_id) {
                supabaseClient
                    .from('notificacoes')
                    .delete()
                    .eq('grupo_id', currentUser.grupo_id)
                    .then(({ error }) => {
                        if (error) {
                            showNotification('Erro ao excluir notificações do banco', 'error');
                            return;
                        }
                        notificacoesSistema = [];
                        atualizarBadgeNotificacoes();
                        atualizarPainelNotificacoes();
                        showNotification('Todas as notificações do grupo foram removidas', 'info');
                    });
            } else {
                notificacoesSistema = [];
                atualizarBadgeNotificacoes();
                atualizarPainelNotificacoes();
                showNotification('Todas as notificações foram removidas', 'info');
            }
        }

        function getIconeNotificacao(tipo) {
            const icones = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle',
                'servico': 'fa-truck',
                'divergencia': 'fa-exclamation-triangle',
                'conclusao': 'fa-check-circle'
            };
            return icones[tipo] || 'fa-bell';
        }

        function getCorNotificacao(tipo) {
            const cores = {
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600',
                'info': 'text-blue-600',
                'servico': 'text-blue-600',
                'divergencia': 'text-red-600',
                'conclusao': 'text-green-600'
            };
            return cores[tipo] || 'text-gray-600';
        }

        function formatarTempoRelativo(data) {
            const agora = new Date();
            const diferenca = agora - new Date(data);
            const minutos = Math.floor(diferenca / 60000);
            
            if (minutos < 1) return 'Agora mesmo';
            if (minutos < 60) return `${minutos}min atrás`;
            
            const horas = Math.floor(minutos / 60);
            if (horas < 24) return `${horas}h atrás`;
            
            const dias = Math.floor(horas / 24);
            return `${dias}d atrás`;
        }

        function executarAcaoNotificacao(acao, notifId) {
            // Marcar como lida
            marcarComoLida(notifId);
            
            // Executar ação específica
            if (acao.startsWith('servico-')) {
                const servicoId = acao.replace('servico-', '');
                verDetalhesServico(servicoId);
                toggleNotificationsPanel(); // Fechar painel
            }
        }

        function showNotification(message, type = 'info') {
            const notificationsContainer = document.getElementById('notifications');
            if (!notificationsContainer) {
                console.error('Container de notificações não encontrado');
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = `notification bg-white border-l-4 ${
                type === 'success' ? 'border-green-500' : 
                type === 'error' ? 'border-red-500' : 
                type === 'warning' ? 'border-yellow-500' : 'border-blue-500'
            } p-4 rounded-lg shadow-lg max-w-sm`;
            
            notification.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle text-green-500' : 
                            type === 'error' ? 'fa-exclamation-circle text-red-500' : 
                            type === 'warning' ? 'fa-exclamation-triangle text-yellow-500' : 'fa-info-circle text-blue-500'
                        }"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-gray-900">${message}</p>
                    </div>
                </div>
            `;
            
            notificationsContainer.appendChild(notification);
            
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.remove();
                }
            }, 2000);
        }

        // Navegação
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Atualizar navegação
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn text-slate-600 px-6 py-3 text-sm font-semibold rounded-lg transition-all';
                btn.classList.remove('active');
            });
            
            // Ativar botão correto
            const activeBtn = document.getElementById(`btn${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}`);
            if (activeBtn) {
                activeBtn.className = 'nav-btn active px-6 py-3 text-sm font-semibold rounded-lg transition-all';
                activeBtn.classList.add('active');
            }
            
            // Carregar dados específicos da seção
            if (sectionName === 'dashboard') {
                atualizarDashboard();
            } else if (sectionName === 'servicos') {
                carregarServicos();
            } else if (sectionName === 'bipagem') {
                carregarSelectsTransportadoras();
            } else if (sectionName === 'relatorios') {
                carregarRelatorios();
            }
        }

        // Adicionar event listeners para os botões do menu
        function configurarEventosMenu() {
            document.getElementById('btnDashboard').addEventListener('click', () => showSection('dashboard'));
            document.getElementById('btnBipagem').addEventListener('click', () => showSection('bipagem'));
            document.getElementById('btnServicos').addEventListener('click', () => showSection('servicos'));
            document.getElementById('btnRelatorios').addEventListener('click', () => showSection('relatorios'));
        }

        // Carregar serviços do Supabase ao iniciar
        async function carregarServicosSupabase() {

            // Buscar grupo_id do usuário logado
            const { data: usuario, error: usuarioError } = await supabaseClient
                .from('usuarios')
                .select('grupo_id')
                .eq('id', currentUser.id)
                .single();

            if (usuarioError || !usuario) {
                showNotification('Erro ao buscar grupo_id do usuário!', 'error');
                servicos = [];
                carregarServicos();
                return;
            }
            const grupo_id = usuario.grupo_id;

            // Buscar todos os serviços do grupo
            const { data: servicosData, error: errorServicos } = await supabaseClient
                .from('servicos')
                .select('*')
                .eq('grupo_id', grupo_id)
                .order('data_criacao', { ascending: false });
            if (errorServicos) {
                showNotification('Erro ao carregar serviços do Supabase!', 'error');
                servicos = [];
                carregarServicos();
                return;
            }


            // Buscar todos os usuários do grupo
            const { data: usuariosGrupo, error: errorUsuariosGrupo } = await supabaseClient
                .from('usuarios')
                .select('id')
                .eq('grupo_id', grupo_id);
            if (errorUsuariosGrupo || !usuariosGrupo) {
                showNotification('Erro ao buscar usuários do grupo para notificações!', 'error');
                notificacoesSistema = [];
            } else {
                // Buscar todas as notificações dos usuários do grupo
                const { data: notificacoesData, error: errorNotificacoes } = await supabaseClient
                    .from('notificacoes')
                    .select('*')
                    .in('usuario_id', usuariosGrupo.map(u => u.id));
                if (!errorNotificacoes && notificacoesData) {
                    notificacoesSistema = notificacoesData;
                } else {
                    notificacoesSistema = [];
                }
            }
            atualizarPainelNotificacoes();

            // Buscar todas as atividades (mostrar para todos)
            const { data: atividadesData, error: errorAtividades } = await supabaseClient
                .from('atividades')
                .select('*');
            if (!errorAtividades && atividadesData) {
                atividades = atividadesData;
            }

            // Buscar divergências dos serviços do grupo
            const idsServicosGrupo = (servicosData || []).map(s => s.id);
            const { data: divergenciasData, error: errorDivergencias } = await supabaseClient
                .from('divergencias')
                .select('*')
                .in('servico_id', idsServicosGrupo);
            if (!errorDivergencias && divergenciasData) {
                // Você pode salvar em uma variável global se usar divergências em outros lugares
                window.divergenciasGrupo = divergenciasData;
            }

            // Buscar todas as transportadoras para montar nomes
            const { data: transportadorasData, error: errorTransp } = await supabaseClient
                .from('transportadoras')
                .select('id, nome, cnpj');
            if (errorTransp) {
                showNotification('Erro ao buscar transportadoras: ' + errorTransp.message, 'error');
                servicos = [];
                carregarServicos();
                return;
            }
            // Montar mapa de transportadoras
            const transpMap = {};
            (transportadorasData || []).forEach(t => {
                transpMap[t.id] = t;
            });

            // Buscar todos os itens de todos os serviços
            const idsServicos = (servicosData || []).map(s => s.id);
            let itensMap = {};
            if (idsServicos.length > 0) {
                const { data: itensData, error: errorItens } = await supabaseClient
                    .from('servico_itens')
                    .select('*')
                    .in('servico_id', idsServicos);
                if (errorItens) {
                    showNotification('Erro ao buscar itens dos serviços: ' + errorItens.message, 'error');
                } else {
                    itensMap = {};
                    (itensData || []).forEach(item => {
                        if (!itensMap[item.servico_id]) itensMap[item.servico_id] = [];
                        itensMap[item.servico_id].push(item);
                    });
                }
            }

            // Buscar todos os usuários relacionados aos serviços
            // Buscar todos os usuários do grupo para garantir nomes corretos
            let usuariosMap = {};
            const { data: usuariosGrupoData, error: errorUsuariosGrupoData } = await supabaseClient
                .from('usuarios')
                .select('id, nome')
                .eq('grupo_id', grupo_id);
            if (!errorUsuariosGrupoData && usuariosGrupoData) {
                usuariosGrupoData.forEach(u => { usuariosMap[u.id] = u.nome; });
            }

            // Montar lista final de serviços com nomes, itens e nome do usuário
            servicos = (servicosData || []).map(s => ({
                ...s,
                origem: transpMap[s.origem_id] || { nome: 'Desconhecido', cnpj: '' },
                destino: transpMap[s.destino_id] || { nome: 'Desconhecido', cnpj: '' },
                dataHora: s.data_criacao,
                usuario: (typeof usuariosMap !== 'undefined' && usuariosMap[s.usuario_id]) ? usuariosMap[s.usuario_id] : 'Desconhecido',
                itens: itensMap[s.id] || []
            }));

            carregarServicos();
        }

        async function carregarTransportadorasSupabase() {
            const { data, error } = await supabaseClient
                .from('transportadoras')
                .select('id, nome')
                .eq('status', 'ativo');
            if (error) {
                showNotification('Erro ao carregar transportadoras!', 'error');
                return;
            }
            transportadoras = data || [];
            carregarSelectsTransportadoras();
        }

        // Inicialização do Sistema
        function inicializarSistema() {
            configurarEventosMenu();
            configurarFiltrosAutomaticos();
            atualizarDashboard();
            carregarTransportadorasSupabase(); // <-- aqui!
            carregarServicosSupabase();
            setInterval(simularAtualizacaoTempoReal, 15000);
        }

        // Dashboard
        function atualizarDashboard() {
            const servicosAtivos = servicos.filter(s => s.status === 'pendente' || s.status === 'andamento').length;
            const concluidosHoje = servicos.filter(s => s.status === 'concluido' && isToday(new Date(s.dataHora))).length;
            const divergencias = servicos.filter(s => s.status === 'divergente').length;
            const estatisticasTempo = calcularEstatisticasTempo();
            
            document.getElementById('servicosAtivos').textContent = servicosAtivos;
            document.getElementById('concluidosHoje').textContent = concluidosHoje;
            document.getElementById('divergenciasTotal').textContent = divergencias;
            document.getElementById('tempoMedio').textContent = estatisticasTempo.medio + 'min';
            
            // Atualizar progresso baseado na eficiência
            const taxaSucesso = calcularTaxaSucesso();
            document.getElementById('progressoAtivos').style.width = taxaSucesso + '%';
            
            // Atualizar indicadores de performance
            atualizarIndicadoresPerformance(estatisticasTempo);
            atualizarGraficoStatus();
            atualizarAtividadeRecente();
        }

        function atualizarIndicadoresPerformance(stats) {
            // Atualizar texto dos cards com informações mais detalhadas
            const cardTempo = document.querySelector('.kpi-card:nth-child(4) .flex.items-center.justify-between.text-sm span:last-child');
            if (cardTempo) {
                if (stats.medio < 30) {
                    cardTempo.textContent = 'Excelente';
                    cardTempo.className = 'text-green-600 font-semibold';
                } else if (stats.medio < 60) {
                    cardTempo.textContent = 'Bom';
                    cardTempo.className = 'text-blue-600 font-semibold';
                } else {
                    cardTempo.textContent = 'Precisa melhorar';
                    cardTempo.className = 'text-red-600 font-semibold';
                }
            }

            // Atualizar indicador de concluídos hoje
            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const concluidosOntem = servicos.filter(s => 
                s.status === 'concluido' && 
                new Date(s.dataHora).toDateString() === ontem.toDateString()
            ).length;
            
            const concluidosHoje = servicos.filter(s => 
                s.status === 'concluido' && 
                isToday(new Date(s.dataHora))
            ).length;
            
            const variacao = concluidosOntem > 0 ? 
                Math.round(((concluidosHoje - concluidosOntem) / concluidosOntem) * 100) : 
                (concluidosHoje > 0 ? 100 : 0);
            
            const cardConcluidos = document.querySelector('.kpi-card:nth-child(2) .flex.items-center.justify-between.text-sm span:last-child');
            if (cardConcluidos) {
                const sinal = variacao >= 0 ? '+' : '';
                cardConcluidos.textContent = `${sinal}${variacao}% vs ontem`;
                cardConcluidos.className = variacao >= 0 ? 'text-emerald-600 font-semibold' : 'text-red-600 font-semibold';
            }
        }

        function atualizarGraficoStatus() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destruir gráfico existente se houver
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }
            
            const statusCount = {
                pendente: servicos.filter(s => s.status === 'pendente').length,
                andamento: servicos.filter(s => s.status === 'andamento').length,
                concluido: servicos.filter(s => s.status === 'concluido').length,
                divergente: servicos.filter(s => s.status === 'divergente').length
            };
            
            window.statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Concluído', 'Divergente'],
                    datasets: [{
                        data: [statusCount.pendente, statusCount.andamento, statusCount.concluido, statusCount.divergente],
                        backgroundColor: ['#fbbf24', '#3b82f6', '#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function atualizarAtividadeRecente() {
            const container = document.getElementById('atividadeRecente');
            container.innerHTML = '';
            
            const atividadesRecentes = atividades.slice(-10).reverse();
            
            atividadesRecentes.forEach((atividade, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-4 p-4 hover:bg-primary-50 rounded-xl transition-all cursor-pointer group';
                item.innerHTML = `
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 icon-container rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas ${atividade.icone} text-primary-600"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-800 group-hover:text-primary-700 transition-colors">${atividade.descricao}</p>
                        <div class="flex items-center space-x-2 mt-1">
                            <p class="text-xs text-slate-500">${formatarDataHora(atividade.dataHora)}</p>
                            <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                            <p class="text-xs text-slate-500">${atividade.usuario}</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <div class="w-2 h-2 bg-primary-400 rounded-full ${index === 0 ? 'animate-pulse' : ''}"></div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (atividadesRecentes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-history text-slate-400 text-2xl"></i>
                        </div>
                        <p class="text-slate-500 font-medium">Nenhuma atividade recente</p>
                    </div>
                `;
            }
        }

        // Sistema de Bipagem
        function carregarSelectsTransportadoras() {
            const origemSelect = document.getElementById('origemSelect');
            const destinoSelect = document.getElementById('destinoSelect');
            const filtroTransportadora = document.getElementById('filtroTransportadora');

            [origemSelect, destinoSelect, filtroTransportadora].forEach(select => {
                if (select) {
                    if (select.id === 'filtroTransportadora') {
                        select.innerHTML = '<option value="">Todas as Transportadoras</option>';
                    } else {
                        select.innerHTML = transportadoras.length === 0 ?
                            '<option value="">Nenhuma transportadora cadastrada</option>' :
                            '<option value="">Selecione...</option>';
                    }
                    transportadoras.forEach(transportadora => {
                        const option = document.createElement('option');
                        option.value = transportadora.id;
                        option.textContent = transportadora.nome;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Função para auto-selecionar destino quando origem é escolhida
        function atualizarDestinoAuto() {
            const origemSelect = document.getElementById('origemSelect');
            const destinoSelect = document.getElementById('destinoSelect');
            const origemId = origemSelect.value;
            if (!origemId) {
                destinoSelect.value = '';
                return;
            }
            // Se só restar uma opção válida para destino, selecione automaticamente
            let opcoes = Array.from(destinoSelect.options).filter(opt => opt.value && opt.value !== origemId);
            if (opcoes.length === 1) {
                destinoSelect.value = opcoes[0].value;
            }
        }

        // Função para auto-selecionar origem quando destino é escolhida
        function atualizarOrigemAuto() {
            const origemSelect = document.getElementById('origemSelect');
            const destinoSelect = document.getElementById('destinoSelect');
            const destinoId = destinoSelect.value;
            if (!destinoId) {
                origemSelect.value = '';
                return;
            }
            let opcoes = Array.from(origemSelect.options).filter(opt => opt.value && opt.value !== destinoId);
            if (opcoes.length === 1) {
                origemSelect.value = opcoes[0].value;
            }
        }

        function adicionarItem() {
            console.log('Função adicionarItem chamada');
            const codigo = document.getElementById('codigoBarras').value.trim();
            const origem = document.getElementById('origemSelect').value;
            const destino = document.getElementById('destinoSelect').value;
            
            if (!codigo) {
                showNotification('Digite um código de barras!', 'warning');
                return;
            }
            
            if (transportadoras.length === 0) {
                showNotification('Nenhuma transportadora disponível!', 'warning');
                return;
            }
            
            if (!origem || !destino) {
                showNotification('Selecione origem e destino!', 'warning');
                return;
            }
            
            if (origem === destino) {
                showNotification('Origem e destino devem ser diferentes!', 'warning');
                return;
            }
            
            // Verificar duplicata
            if (itensBipagem.some(item => item.codigo === codigo)) {
                showNotification('Item já foi bipado!', 'warning');
                return;
            }
            
            const item = {
                id: Date.now(),
                codigo: codigo,
                dataHora: new Date(),
                origem: origem,
                destino: destino
            };
            
            itensBipagem.push(item);
            atualizarListaItens();
            document.getElementById('codigoBarras').value = '';
            document.getElementById('codigoBarras').focus();
            
            showNotification('Item adicionado com sucesso!', 'success');
            console.log('Chamando adicionarNotificacaoSistema (adicionarItem)', currentUser.grupo_id, `Item ${codigo} adicionado ao serviço em bipagem.`, 'info');
            adicionarNotificacaoSistema(currentUser.grupo_id, `Item ${codigo} adicionado ao serviço em bipagem.`, 'info');
        }

        function atualizarListaItens() {
            const container = document.getElementById('listaItens');
            const contador = document.getElementById('contadorItens');
            
            contador.textContent = `${itensBipagem.length} itens`;
            container.innerHTML = '';
            
            itensBipagem.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-barcode text-gray-400"></i>
                        <div>
                            <p class="font-medium text-gray-900">${item.codigo}</p>
                            <p class="text-sm text-gray-500">${formatarDataHora(item.dataHora)}</p>
                        </div>
                    </div>
                    <button onclick="removerItem(${item.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function removerItem(id) {
            console.log('Função removerItem chamada');
            itensBipagem = itensBipagem.filter(item => item.id !== id);
            atualizarListaItens();
            showNotification('Item removido!', 'info');
            console.log('Chamando adicionarNotificacaoSistema (removerItem)', currentUser.grupo_id, 'Um item foi removido da bipagem.', 'warning');
            adicionarNotificacaoSistema(currentUser.grupo_id, `Um item foi removido da bipagem.`, 'warning');
        }
        // Criar serviço e salvar no Supabase
        async function criarServico() {
            console.log('Função criarServico chamada');
            if (itensBipagem.length === 0) {
                showNotification('Adicione pelo menos um item!', 'warning');
                return;
            }

            const origemId = document.getElementById('origemSelect').value;      // deve ser UUID
            const destinoId = document.getElementById('destinoSelect').value;    // deve ser UUID
            const usuarioId = currentUser.id;                                    // deve ser UUID


            // Buscar todos os ids existentes na tabela servicos para garantir unicidade
            const { data: servicosExistentes, error: errorBuscaServicos } = await supabaseClient
                .from('servicos')
                .select('id');
            let maiorNumero = 0;
            if (servicosExistentes && servicosExistentes.length > 0) {
                servicosExistentes.forEach(s => {
                    if (typeof s.id === 'string' && s.id.startsWith('S')) {
                        const num = parseInt(s.id.substring(1), 10);
                        if (!isNaN(num) && num > maiorNumero) maiorNumero = num;
                    }
                });
            }
            const proximoNumero = (maiorNumero + 1).toString().padStart(6, '0');
            const novoId = 'S' + proximoNumero;


            // Buscar grupo_id do usuário logado
            const { data: usuarioGrupo, error: errorGrupo } = await supabaseClient
                .from('usuarios')
                .select('grupo_id')
                .eq('id', currentUser.id)
                .single();
            const grupo_id = usuarioGrupo ? usuarioGrupo.grupo_id : null;

            const servico = {
                id: novoId, // Exemplo: S000001
                origem_id: origemId,
                destino_id: destinoId,
                usuario_id: usuarioId,
                grupo_id: grupo_id,
                status: 'pendente',
                progresso: 0,
                total_itens: itensBipagem.length,
                itens_conferidos: 0,
                data_criacao: new Date().toISOString()
                // Adicione outros campos do schema se necessário
            };

            const { error } = await supabaseClient
                .from('servicos')
                .insert([servico]);

            if (error) {
                showNotification('Erro ao salvar serviço! ' + error.message, 'error');
                return;
            }

            // Salvar itens na tabela servico_itens
            if (itensBipagem.length > 0) {
                const itensToInsert = itensBipagem.map(item => ({
                    servico_id: novoId,
                    codigo_barras: item.codigo || item.codigo_barras || '',
                    tipo: item.tipo || 'enviado',
                    conferido: item.conferido || false,
                    data_bipagem: item.data_bipagem || new Date().toISOString(),
                    data_conferencia: item.data_conferencia || null
                }));
                const { error: errorItens } = await supabaseClient
                    .from('servico_itens')
                    .insert(itensToInsert);
                if (errorItens) {
                    showNotification('Serviço salvo, mas erro ao salvar itens: ' + errorItens.message, 'warning');
                }
            }

            showNotification('Serviço criado com sucesso!', 'success');
            console.log('Chamando adicionarNotificacaoSistema (criarServico)', currentUser.grupo_id, `O serviço ${novoId} foi criado por ${currentUser.nome}.`, 'servico');
            adicionarNotificacaoSistema(currentUser.grupo_id, `O serviço ${novoId} foi criado por ${currentUser.nome}.`, 'servico');
            limparBipagem();
            await carregarServicosSupabase();
        }
        function limparBipagem() {
            itensBipagem = [];
            atualizarListaItens();
            document.getElementById('origemSelect').value = '';
            document.getElementById('destinoSelect').value = '';
            document.getElementById('codigoBarras').value = '';
        }

        // Gerenciamento de Serviços
        function carregarServicos() {
            const container = document.getElementById('gridServicos');
            container.innerHTML = '';
            
            let servicosFiltrados = [...servicos];
            
            // Ordenar por data mais recente primeiro
            servicosFiltrados.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
            
            // Aplicar filtros se existirem
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroTransportadora = document.getElementById('filtroTransportadora').value;
            const filtroData = document.getElementById('filtroData').value;
            
            if (filtroStatus) {
                if (filtroStatus === 'divergente') {
                    servicosFiltrados = servicosFiltrados.filter(s => s.status === 'divergente' || s.concluido_com_divergencia === true || s.concluidoComDivergencia === true);
                } else {
                    servicosFiltrados = servicosFiltrados.filter(s => s.status === filtroStatus);
                }
            }
            
            if (filtroTransportadora) {
                servicosFiltrados = servicosFiltrados.filter(s => 
                    s.origem.id == filtroTransportadora || s.destino.id == filtroTransportadora
                );
            }
            
            if (filtroData) {
                servicosFiltrados = servicosFiltrados.filter(s => 
                    s.dataHora.toDateString() === new Date(filtroData).toDateString()
                );
            }
            
            // PAGINAÇÃO
            const pageSize = 9;
            let currentPage = window.servicosCurrentPage || 1;
            const totalPages = Math.ceil(servicosFiltrados.length / pageSize);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            window.servicosCurrentPage = currentPage;

            // Slice the services for the current page
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const servicosPagina = servicosFiltrados.slice(startIdx, endIdx);

            servicosPagina.forEach(servico => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm p-6 card-hover';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${servico.id}</h3>
                            <p class="text-sm text-gray-600">${servico.origem.nome} → ${servico.destino.nome}</p>
                        </div>
                        <span>
                            ${getStatusText(servico.status, servico)}
                        </span>
                    </div>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Itens:</span>
                            <span class="font-medium">${servico.itens.length}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Criado:</span>
                            <span class="font-medium">${formatarDataHora(servico.dataHora)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Usuário:</span>
                            <span class="font-medium">${servico.usuario ? servico.usuario : (typeof usuariosMap !== 'undefined' && usuariosMap[servico.usuario_id] ? usuariosMap[servico.usuario_id] : 'Desconhecido')}</span>
                        </div>
                    </div>
                    ${servico.status !== 'pendente' ? `
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">Progresso</span>
                                <span class="font-medium">${servico.progresso}%</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${servico.progresso}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="flex space-x-2 mb-4">
                        ${servico.status === 'pendente' ? `
                            <button onclick="iniciarConferencia('${servico.id}')" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 text-sm">
                                <i class="fas fa-play mr-1"></i>Iniciar
                            </button>
                        ` : ''}
                        <button onclick="verDetalhesServico('${servico.id}')" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 text-sm">
                            <i class="fas fa-eye mr-1"></i>Ver
                        </button>
                    </div>
                    ${(servico.divergencias && servico.divergencias.length > 0) || servico.status === 'divergente' ? `
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-sm text-red-600">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                ${servico.divergencias && servico.divergencias.length > 0 ? `${servico.divergencias.length} divergência(s) encontrada(s)` : 'Divergência detectada neste serviço'}
                            </p>
                        </div>
                    ` : ''}
                `;
                container.appendChild(card);
            });

            // Pagination controls
            const paginacaoDiv = document.getElementById('servicosPaginacao') || document.createElement('div');
            paginacaoDiv.id = 'servicosPaginacao';
            paginacaoDiv.className = 'flex justify-center items-center mt-4 gap-2';
            paginacaoDiv.innerHTML = '';
            if (totalPages > 1) {
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Anterior';
                prevBtn.className = 'px-3 py-1 rounded bg-slate-200 hover:bg-slate-300';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = function() {
                    window.servicosCurrentPage = currentPage - 1;
                    carregarServicos();
                };
                paginacaoDiv.appendChild(prevBtn);

                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.className = 'px-2 py-1 rounded ' + (i === currentPage ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200');
                    pageBtn.onclick = function() {
                        window.servicosCurrentPage = i;
                        carregarServicos();
                    };
                    paginacaoDiv.appendChild(pageBtn);
                }

                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Próximo';
                nextBtn.className = 'px-3 py-1 rounded bg-slate-200 hover:bg-slate-300';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = function() {
                    window.servicosCurrentPage = currentPage + 1;
                    carregarServicos();
                };
                paginacaoDiv.appendChild(nextBtn);
            }

            // Add pagination below the grid
            if (!document.getElementById('servicosPaginacao')) {
                container.parentNode.appendChild(paginacaoDiv);
            } else {
                document.getElementById('servicosPaginacao').replaceWith(paginacaoDiv);
            }

            if (servicosFiltrados.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">Nenhum serviço encontrado</p>
                    </div>
                `;
            }
        }

        function aplicarFiltros() {
            carregarServicos();
        }

        function limparFiltros() {
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroTransportadora').value = '';
            document.getElementById('filtroData').value = '';
            carregarServicos();
        }

        // Configurar filtros automáticos
        function configurarFiltrosAutomaticos() {
            document.getElementById('filtroStatus').addEventListener('change', carregarServicos);
            document.getElementById('filtroTransportadora').addEventListener('change', carregarServicos);
            document.getElementById('filtroData').addEventListener('change', carregarServicos);
        }

        function verDetalhesServico(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;
            
            // Criar modal de detalhes
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold text-gray-900">Detalhes do Serviço</h3>
                                <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Informações Gerais -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-3">Informações Gerais</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">ID do Serviço:</span>
                                            <span class="font-medium">${servico.id}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Status:</span>
                                            <span style="display: flex; gap: 4px; align-items: center;">
                                                ${getStatusText(servico.status, servico)}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Criado em:</span>
                                            <span class="font-medium">${formatarDataHora(servico.dataHora)}</span>
                                        </div>
                                        ${servico.dataFinalizacao ? `
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Finalizado em:</span>
                                                <span class="font-medium">${formatarDataHora(servico.dataFinalizacao)}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Usuário:</span>
                                            <span class="font-medium">${servico.usuario}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${servico.comentarioConclusao ? `
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-orange-800 mb-2">
                                            <i class="fas fa-comment mr-2"></i>Comentário da Conclusão
                                        </h4>
                                        <p class="text-sm text-orange-700">${servico.comentarioConclusao}</p>
                                        ${servico.concluidoComDivergencia ? `
                                            <p class="text-xs text-orange-600 mt-2">
                                                <i class="fas fa-info-circle mr-1"></i>Serviço concluído mesmo com divergências
                                            </p>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-3">Rota</h4>
                                    <div class="space-y-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">Origem:</span>
                                            <p class="font-medium">${servico.origem.nome}</p>
                                            <p class="text-xs text-gray-500">${servico.origem.cnpj}</p>
                                        </div>
                                        <div class="flex justify-center py-2">
                                            <i class="fas fa-arrow-down text-blue-600"></i>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Destino:</span>
                                            <p class="font-medium">${servico.destino.nome}</p>
                                            <p class="text-xs text-gray-500">${servico.destino.cnpj}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progresso -->
                            ${servico.status !== 'pendente' ? `
                                <div class="mb-6">
                                    <h4 class="font-semibold text-gray-900 mb-3">Progresso da Conferência</h4>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex justify-between text-sm mb-2">
                                            <span class="text-gray-600">Progresso</span>
                                            <span class="font-medium">${servico.progresso}%</span>
                                        </div>
                                        <div class="bg-gray-200 rounded-full h-3">
                                            <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: ${servico.progresso}%"></div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Lista de Itens -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-900 mb-3">Itens do Serviço (${servico.itens.length})</h4>
                                <div class="bg-gray-50 p-4 rounded-lg max-h-64 overflow-y-auto">
                                    <div class="space-y-2">
                                        ${servico.itens.map((item, index) => {
                                            const codigo = item.codigo_barras || item.codigo || '';
                                            const data = item.data_bipagem || item.dataHora || null;
                                            const dataFormatada = data ? formatarDataHora(data) : '';
                                            return `
                                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                                    <div class="flex items-center space-x-3">
                                                        <span class="text-xs text-gray-500 w-8">${index + 1}</span>
                                                        <i class="fas fa-barcode text-gray-400"></i>
                                                        <span class="font-mono text-sm">${codigo}</span>
                                                    </div>
                                                    <span class="text-xs text-gray-500">${dataFormatada}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Divergências -->
                            ${servico.divergencias && servico.divergencias.length > 0 ? `
                                <div class="mb-6">
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <h4 class="font-semibold text-red-800 mb-2">Divergências Detectadas</h4>
                                        <p class="text-sm text-red-600 mb-3">${servico.divergencias.length} item(ns) com divergência encontrado(s)</p>
                                        <div class="space-y-2">
                                            ${servico.divergencias.map(div => `
                                                <div class="bg-white p-3 rounded border-l-4 border-red-500">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-mono text-sm font-bold">${div.codigo}</p>
                                                            <p class="text-xs text-red-600">${div.descricao}</p>
                                                        </div>
                                                        <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded">
                                                            ${div.tipo === 'extra' ? 'Extra' : 'Faltando'}
                                                        </span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Ações -->
                            <div class="flex justify-between items-center pt-6 border-t">
                                <div class="flex space-x-4">
                                    ${servico.status === 'pendente' ? `
                                        <button onclick="excluirServico('${servico.id}')" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-all">
                                            <i class="fas fa-trash mr-2"></i>Excluir Serviço
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="flex space-x-4">
                                    ${servico.status === 'pendente' ? `
                                        <button onclick="iniciarConferencia('${servico.id}'); this.closest('.modal-backdrop').remove();" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                            <i class="fas fa-play mr-2"></i>Iniciar Conferência
                                        </button>
                                    ` : ''}
                                    ${servico.status === 'divergente' ? `
                                        <button onclick="abrirModalConclusao('${servico.id}')" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 mr-2">
                                            <i class="fas fa-check-circle mr-2"></i>Concluir com Divergência
                                        </button>
                                    ` : ''}
                                    <button onclick="this.closest('.modal-backdrop').remove()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
                                        Fechar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function iniciarConferencia(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;
            
            servicoAtualConferencia = servico;
            itensRecebidos = [];
            
            // Atualizar status para "em andamento"
            servico.status = 'andamento';
            servico.progresso = 0;
            
            // Adicionar atividade
            atividades.push({
                id: Date.now(),
                descricao: `Conferência iniciada para ${servico.id} por ${currentUser.nome}`,
                dataHora: new Date(),
                icone: 'fa-play',
                usuario: currentUser.nome
            });
            
            // Adicionar notificação do sistema
            adicionarNotificacaoSistema(
                currentUser.grupo_id,
                `Conferência do serviço ${servico.id} foi iniciada`,
                'info',
                `servico-${servico.id}`
            );
            
            // Abrir modal
            document.getElementById('infoServico').textContent = `${servico.id} - ${servico.origem.nome} → ${servico.destino.nome}`;
            document.getElementById('totalEnviados').textContent = servico.itens.length;
            document.getElementById('totalRecebidos').textContent = '0';
            document.getElementById('totalDivergencias').textContent = '0';
            
            atualizarListasConferencia();
            document.getElementById('modalConferencia').classList.remove('hidden');
            document.getElementById('codigoConferencia').focus();
            
            carregarServicos();
            showNotification('Conferência iniciada!', 'success');
        }

        function conferirItem() {
            const codigo = document.getElementById('codigoConferencia').value.trim();
            if (!codigo) {
                showNotification('Digite um código!', 'warning');
                return;
            }
            
            // Verificar se já foi recebido (comparando por codigo_barras OU codigo)
            if (itensRecebidos.some(item => (item.codigo_barras || item.codigo || '') === codigo)) {
                showNotification('Item já foi conferido!', 'warning');
                document.getElementById('codigoConferencia').value = '';
                return;
            }

            // Conferir se o código existe na lista de itens do serviço (comparando por codigo_barras OU codigo)
            const encontrado = servicoAtualConferencia.itens.some(i => {
                const cod = i.codigo_barras || i.codigo || '';
                return cod === codigo;
            });

            const item = {
                codigo: codigo,
                dataHora: new Date(),
                encontrado: encontrado
            };

            itensRecebidos.push(item);

            // Atualizar contadores
            document.getElementById('totalRecebidos').textContent = itensRecebidos.length;

            // Calcular progresso
            const progresso = Math.round((itensRecebidos.length / servicoAtualConferencia.itens.length) * 100);
            servicoAtualConferencia.progresso = Math.min(progresso, 100);

            atualizarListasConferencia();
            analisarDivergencias();

            document.getElementById('codigoConferencia').value = '';
            document.getElementById('codigoConferencia').focus();

            if (item.encontrado) {
                showNotification('Item conferido com sucesso!', 'success');
            } else {
                showNotification('Item extra detectado!', 'warning');
                // Som de alerta (simulado)
                console.log('🔊 ALERTA: Item extra detectado!');
            }
        }

        function atualizarListasConferencia() {
            // Lista de enviados
            const listaEnviados = document.getElementById('listaEnviados');
            listaEnviados.innerHTML = '';
            
            servicoAtualConferencia.itens.forEach(item => {
                // Corrigir para usar o campo correto do banco: codigo_barras
                const codigo = item.codigo_barras || item.codigo || '';
                const data = item.data_bipagem || item.dataHora || null;
                const dataFormatada = data ? formatarDataHora(data) : '';
                const encontrado = itensRecebidos.some(r => r.codigo === codigo);
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded ${encontrado ? 'bg-green-50 text-green-800' : 'bg-gray-50'}`;
                div.innerHTML = `
                    <span class="text-sm">${codigo}</span>
                    <span class="text-xs text-gray-500 ml-2">${dataFormatada}</span>
                    ${encontrado ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-clock text-gray-400"></i>'}
                `;
                listaEnviados.appendChild(div);
            });
            
            // Lista de recebidos
            const listaRecebidos = document.getElementById('listaRecebidos');
            listaRecebidos.innerHTML = '';
            
            itensRecebidos.forEach((item, index) => {
                // Corrigir para mostrar o código e a data corretamente
                const codigo = item.codigo_barras || item.codigo || '';
                let data = item.data_bipagem || item.dataHora || null;
                let dataFormatada = data ? formatarDataHora(data) : '';
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded ${item.encontrado ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`;
                div.innerHTML = `
                    <span class="text-sm">${codigo}</span>
                    <span class="text-xs text-gray-500 ml-2">${dataFormatada}</span>
                    <div class="flex items-center space-x-2">
                        ${item.encontrado ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-exclamation-triangle text-red-600"></i>'}
                        <button onclick="removerItemRecebido(${index})" class="text-red-600 hover:text-red-800 ml-2">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                listaRecebidos.appendChild(div);
            });
        }

        function removerItemRecebido(index) {
            itensRecebidos.splice(index, 1);
            
            // Atualizar contadores
            document.getElementById('totalRecebidos').textContent = itensRecebidos.length;
            
            // Recalcular progresso
            const progresso = Math.round((itensRecebidos.length / servicoAtualConferencia.itens.length) * 100);
            servicoAtualConferencia.progresso = Math.min(progresso, 100);
            
            atualizarListasConferencia();
            analisarDivergencias();
            
            showNotification('Item removido da conferência!', 'info');
        }

        function analisarDivergencias() {
            const divergencias = [];
            
            // Itens extras (recebidos mas não enviados)
            const extras = itensRecebidos.filter(r => !servicoAtualConferencia.itens.some(e => {
                const cod = e.codigo_barras || e.codigo || '';
                return cod === (r.codigo_barras || r.codigo || '');
            }));
            extras.forEach(item => {
                const codigo = item.codigo_barras || item.codigo || '';
                divergencias.push({
                    tipo: 'extra',
                    codigo: codigo,
                    descricao: 'Item extra - não constava na lista de envio',
                    severidade: 'media'
                });
            });

            // Itens faltando (enviados mas não recebidos)
            const faltando = servicoAtualConferencia.itens.filter(e => {
                const cod = e.codigo_barras || e.codigo || '';
                return !itensRecebidos.some(r => (r.codigo_barras || r.codigo || '') === cod);
            });
            faltando.forEach(item => {
                const codigo = item.codigo_barras || item.codigo || '';
                divergencias.push({
                    tipo: 'faltando',
                    codigo: codigo,
                    descricao: 'Item faltando - não foi encontrado na conferência',
                    severidade: 'critica'
                });
            });
            
            servicoAtualConferencia.divergencias = divergencias;
            document.getElementById('totalDivergencias').textContent = divergencias.length;

            // Mostrar/ocultar alerta de divergências em tempo real
            const alertaDivergencias = document.getElementById('alertaDivergencias');
            const mensagemDivergencias = document.getElementById('mensagemDivergencias');

            // O alerta deve ficar sempre visível durante a conferência
            alertaDivergencias.classList.remove('hidden');
            const tituloDivergencias = alertaDivergencias.querySelector('h4');
            const box = alertaDivergencias.querySelector('.bg-red-50, .bg-green-50');
            const icon = alertaDivergencias.querySelector('i');

            if (divergencias.length > 0) {
                const extras = divergencias.filter(d => d.tipo === 'extra').length;
                const faltando = divergencias.filter(d => d.tipo === 'faltando').length;

                let mensagem = `${divergencias.length} divergência(s) encontrada(s)`;
                if (extras > 0 && faltando > 0) {
                    mensagem += ` - ${extras} extra(s) e ${faltando} faltando`;
                } else if (extras > 0) {
                    mensagem += ` - ${extras} item(ns) extra(s)`;
                } else if (faltando > 0) {
                    mensagem += ` - ${faltando} item(ns) faltando`;
                }
                mensagemDivergencias.textContent = mensagem;
                mensagemDivergencias.classList.remove('text-green-600');
                mensagemDivergencias.classList.add('text-red-600');
                if (tituloDivergencias) {
                    tituloDivergencias.textContent = 'Divergências Detectadas';
                    tituloDivergencias.classList.remove('text-green-800');
                    tituloDivergencias.classList.add('text-red-800');
                }
                if (box) {
                    box.classList.remove('bg-green-50', 'border-green-200');
                    box.classList.add('bg-red-50', 'border-red-200');
                }
                if (icon) {
                    icon.className = 'fas fa-exclamation-triangle text-red-600 text-xl mr-3';
                }
            } else {
                mensagemDivergencias.textContent = 'Tudo conferido! Nenhuma divergência encontrada.';
                mensagemDivergencias.classList.remove('text-red-600');
                mensagemDivergencias.classList.add('text-green-600');
                if (tituloDivergencias) {
                    tituloDivergencias.textContent = 'Tudo conferido!';
                    tituloDivergencias.classList.remove('text-red-800');
                    tituloDivergencias.classList.add('text-green-800');
                }
                if (box) {
                    box.classList.remove('bg-red-50', 'border-red-200');
                    box.classList.add('bg-green-50', 'border-green-200');
                }
                if (icon) {
                    icon.className = 'fas fa-check-circle text-green-600 text-xl mr-3';
                }
            }
        }

        function finalizarConferencia() {
            if (!servicoAtualConferencia) {
                showNotification('Erro: Nenhuma conferência ativa encontrada!', 'error');
                return;
            }
            
            // Verificar se há divergências antes de acessar a propriedade
            const divergencias = servicoAtualConferencia.divergencias || [];
            
            // Salvar itens recebidos no serviço
            servicoAtualConferencia.itensRecebidos = [...itensRecebidos];
            
            // Determinar status final
            let novoStatus = '';
            if (divergencias.length > 0) {
                novoStatus = 'divergente';
            } else {
                novoStatus = 'concluido';
                servicoAtualConferencia.progresso = 100;
            }
            servicoAtualConferencia.status = novoStatus;
            servicoAtualConferencia.dataFinalizacao = new Date();

            // Persistir atualização no Supabase e aguardar antes de atualizar UI
            (async () => {
                // Garantir que servicoAtualConferencia existe antes de acessar id
                if (!servicoAtualConferencia || !servicoAtualConferencia.id) {
                    showNotification('Erro ao finalizar: serviço não encontrado.', 'error');
                    return;
                }
                // Salvar referência antes de fechar o modal
                const servicoFinalizado = servicoAtualConferencia;

                // Salvar divergências na tabela 'divergencias'
                if (divergencias.length > 0) {
                    for (const div of divergencias) {
                        await supabaseClient
                            .from('divergencias')
                            .insert([{
                                servico_id: servicoFinalizado.id,
                                codigo_barras: div.codigo_barras || div.codigo || '',
                                tipo: div.tipo || 'extra',
                                descricao: div.descricao || '',
                                severidade: div.severidade || 'media',
                                resolvida: false,
                                observacoes: div.observacao || '',
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }]);
                    }
                }

                // Corrigir nome do campo para data_finalizacao (padrão snake_case do Supabase)
                const { error } = await supabaseClient
                    .from('servicos')
                    .update({
                        status: novoStatus,
                        progresso: servicoFinalizado.progresso,
                        data_finalizacao: servicoFinalizado.dataFinalizacao.toISOString()
                    })
                    .eq('id', servicoFinalizado.id);

                // Adicionar atividade e notificação após persistência
                atividades.push({
                    id: Date.now(),
                    descricao: `Conferência finalizada para ${servicoFinalizado.id} - Status: ${getStatusText(servicoFinalizado.status)}`,
                    dataHora: new Date(),
                    icone: servicoFinalizado.status === 'concluido' ? 'fa-check' : 'fa-exclamation-triangle',
                    usuario: currentUser.nome
                });

                if (servicoFinalizado.status === 'concluido') {
                    adicionarNotificacaoSistema(
                        currentUser.grupo_id,
                        `Serviço ${servicoFinalizado.id} foi concluído com sucesso`,
                        'conclusao',
                        `servico-${servicoFinalizado.id}`
                    );
                } else {
                    adicionarNotificacaoSistema(
                        currentUser.grupo_id,
                        `Serviço ${servicoFinalizado.id} finalizado com ${divergencias.length} divergência(s)`,
                        'divergencia',
                        `servico-${servicoFinalizado.id}`
                    );
                }

                fecharModalConferencia();
                await carregarServicosSupabase();
                atualizarDashboard();

                // Removido chamada errada, só notificar usando UUID do grupo
                showNotification(`Conferência finalizada! Status: ${getStatusText(servicoFinalizado.status)}`, servicoFinalizado.status === 'concluido' ? 'success' : 'warning');

                // Simular notificação colaborativa
                setTimeout(() => {
                    simularAtualizacaoColaborativa(`Conferência finalizada para ${servicoFinalizado.id}`, 'info');
                }, 1000);
            })();

            // Salvar referência antes de fechar o modal
            const servicoFinalizado = servicoAtualConferencia;

            // Adicionar atividade
            atividades.push({
                id: Date.now(),
                descricao: `Conferência finalizada para ${servicoFinalizado.id} - Status: ${getStatusText(servicoFinalizado.status)}`,
                dataHora: new Date(),
                icone: servicoFinalizado.status === 'concluido' ? 'fa-check' : 'fa-exclamation-triangle',
                usuario: currentUser.nome
            });

            // Adicionar notificação do sistema
            if (servicoFinalizado.status === 'concluido') {
                adicionarNotificacaoSistema(
                    currentUser.grupo_id,
                    `Serviço ${servicoFinalizado.id} foi concluído com sucesso`,
                    'conclusao',
                    `servico-${servicoFinalizado.id}`
                );
            } else {
                adicionarNotificacaoSistema(
                    currentUser.grupo_id,
                    `Serviço ${servicoFinalizado.id} finalizado com ${divergencias.length} divergência(s)`,
                    'divergencia',
                    `servico-${servicoFinalizado.id}`
                );
            }

            fecharModalConferencia();
            carregarServicos();
            atualizarDashboard();

            showNotification(`Conferência finalizada! Status: ${getStatusText(servicoFinalizado.status)}`, 
                servicoFinalizado.status === 'concluido' ? 'success' : 'warning');

            // Simular notificação colaborativa
            setTimeout(() => {
                simularAtualizacaoColaborativa(`Conferência finalizada para ${servicoFinalizado.id}`, 'info');
            }, 1000);
        }

        function fecharModalConferencia() {
            document.getElementById('modalConferencia').classList.add('hidden');
            servicoAtualConferencia = null;
            itensRecebidos = [];
        }

        // Relatórios
        function carregarRelatorios() {
            // Carregar select de transportadoras
            const filtroRelatorioTransportadora = document.getElementById('filtroRelatorioTransportadora');
            if (filtroRelatorioTransportadora) {
                filtroRelatorioTransportadora.innerHTML = '<option value="">Todas</option>';
                transportadoras.filter(t => t.status === 'ativo').forEach(transportadora => {
                    const option = document.createElement('option');
                    option.value = transportadora.id;
                    option.textContent = transportadora.nome;
                    filtroRelatorioTransportadora.appendChild(option);
                });
            }
            
            // Definir datas padrão (último mês)
            const hoje = new Date();
            const umMesAtras = new Date();
            umMesAtras.setMonth(hoje.getMonth() - 1);
            
            document.getElementById('dataInicio').value = umMesAtras.toISOString().split('T')[0];
            document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
            
            // Gerar relatório inicial
            gerarRelatorioCompleto();
        }

        function gerarRelatorioCompleto() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const tipo = document.getElementById('tipoRelatorio').value;
            const transportadora = document.getElementById('filtroRelatorioTransportadora').value;
            
            // Filtrar serviços por período
            let servicosFiltrados = servicos;
            console.log('[Relatorio] Total de serviços carregados:', servicos.length);
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                fim.setHours(23, 59, 59, 999); // Incluir todo o dia final
                servicosFiltrados = servicos.filter(s => {
                    const dataServico = new Date(s.dataHora);
                    return dataServico >= inicio && dataServico <= fim;
                });
                console.log('[Relatorio] Serviços após filtro de data:', servicosFiltrados.length, 'De', inicio, 'até', fim);
            }
            if (transportadora) {
                const antes = servicosFiltrados.length;
                servicosFiltrados = servicosFiltrados.filter(s => 
                    s.origem.id == transportadora || s.destino.id == transportadora
                );
                console.log('[Relatorio] Serviços após filtro de transportadora:', servicosFiltrados.length, '(antes:', antes, ')');
            }
            if (tipo === 'divergencias') {
                const antes = servicosFiltrados.length;
                servicosFiltrados = servicosFiltrados.filter(s => s.status === 'divergente' || s.concluido_com_divergencia === true);
                console.log('[Relatorio] Serviços após filtro de divergências:', servicosFiltrados.length, '(antes:', antes, ')');
            }
            atualizarKPIsRelatorio(servicosFiltrados);
            atualizarGraficosRelatorio(servicosFiltrados);
            atualizarTabelaHistorico(servicosFiltrados);
            atualizarTopTransportadoras(servicosFiltrados);
            atualizarAnaliseDivergencias(servicosFiltrados);
            showNotification('Relatório atualizado com sucesso!', 'success');
        }

        function atualizarKPIsRelatorio(servicosFiltrados) {
            const totalServicos = servicosFiltrados.length;
            const servicosConcluidos = servicosFiltrados.filter(s => s.status === 'concluido').length;
            const servicosDivergentes = servicosFiltrados.filter(s => s.status === 'divergente' || s.concluido_com_divergencia === true).length;
            const taxaSucesso = totalServicos > 0 ? Math.round((servicosConcluidos / totalServicos) * 100) : 0;
            
            // Calcular tempo médio
            const servicosFinalizados = servicosFiltrados.filter(s => s.dataFinalizacao);
            let tempoMedio = 0;
            if (servicosFinalizados.length > 0) {
                const tempoTotal = servicosFinalizados.reduce((total, servico) => {
                    const tempo = (new Date(servico.dataFinalizacao) - new Date(servico.dataHora)) / (1000 * 60);
                    return total + tempo;
                }, 0);
                tempoMedio = Math.round(tempoTotal / servicosFinalizados.length);
            }
            if (!isFinite(tempoMedio) || isNaN(tempoMedio)) tempoMedio = 0;
            document.getElementById('relatorioTotalServicos').textContent = totalServicos;
            document.getElementById('relatorioTaxaSucesso').textContent = taxaSucesso + '%';
            document.getElementById('relatorioTotalDivergencias').textContent = servicosDivergentes;
            document.getElementById('relatorioTempoMedio').textContent = tempoMedio + 'min';
        }

        function atualizarGraficosRelatorio(servicosFiltrados) {
            console.log('[Relatorio] Serviços enviados para gráficos:', servicosFiltrados.length, servicosFiltrados);
            // Gráfico de Taxa de Sucesso
            const ctxSucesso = document.getElementById('sucessoChart').getContext('2d');
            if (window.sucessoChartInstance) {
                window.sucessoChartInstance.destroy();
            }
            
            // Agrupar por semana
            const semanas = {};
            servicosFiltrados.forEach(s => {
                const semana = getWeekKey(new Date(s.dataHora));
                if (!semanas[semana]) {
                    semanas[semana] = { total: 0, sucesso: 0 };
                }
                semanas[semana].total++;
                if (s.status === 'concluido') {
                    semanas[semana].sucesso++;
                }
            });
            
            const labelsSemanas = Object.keys(semanas).sort();
            const dadosSucesso = labelsSemanas.map(semana => {
                const dados = semanas[semana];
                return dados.total > 0 ? Math.round((dados.sucesso / dados.total) * 100) : 0;
            });
            
            window.sucessoChartInstance = new Chart(ctxSucesso, {
                type: 'line',
                data: {
                    labels: labelsSemanas,
                    datasets: [{
                        label: 'Taxa de Sucesso (%)',
                        data: dadosSucesso,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de Status
            const ctxStatus = document.getElementById('statusRelatorioChart').getContext('2d');
            if (window.statusRelatorioChartInstance) {
                window.statusRelatorioChartInstance.destroy();
            }
            
            const statusCount = {
                pendente: servicosFiltrados.filter(s => s.status === 'pendente').length,
                andamento: servicosFiltrados.filter(s => s.status === 'andamento').length,
                concluido: servicosFiltrados.filter(s => s.status === 'concluido').length,
                divergente: servicosFiltrados.filter(s => s.status === 'divergente' || s.concluido_com_divergencia === true).length
            };
            
            window.statusRelatorioChartInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Concluído', 'Divergente'],
                    datasets: [{
                        data: [statusCount.pendente, statusCount.andamento, statusCount.concluido, statusCount.divergente],
                        backgroundColor: ['#fbbf24', '#3b82f6', '#10b981', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Gráfico por Transportadora
            const ctxTransportadora = document.getElementById('transportadoraChart').getContext('2d');
            if (window.transportadoraChartInstance) {
                window.transportadoraChartInstance.destroy();
            }
            
            const transportadoraCount = {};
            servicosFiltrados.forEach(s => {
                const origem = s.origem.nome;
                transportadoraCount[origem] = (transportadoraCount[origem] || 0) + 1;
            });
            
            const labelsTransportadora = Object.keys(transportadoraCount);
            const dadosTransportadora = Object.values(transportadoraCount);
            
            window.transportadoraChartInstance = new Chart(ctxTransportadora, {
                type: 'bar',
                data: {
                    labels: labelsTransportadora,
                    datasets: [{
                        label: 'Serviços Enviados',
                        data: dadosTransportadora,
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Gráfico Mensal
            const ctxMensal = document.getElementById('mensalChart').getContext('2d');
            if (window.mensalChartInstance) {
                window.mensalChartInstance.destroy();
            }
            
            const meses = {};
            servicosFiltrados.forEach(s => {
                const mes = new Date(s.dataHora).toLocaleDateString('pt-BR', { year: 'numeric', month: 'short' });
                meses[mes] = (meses[mes] || 0) + 1;
            });
            
            const labelsMeses = Object.keys(meses).sort();
            const dadosMeses = labelsMeses.map(mes => meses[mes]);
            
            window.mensalChartInstance = new Chart(ctxMensal, {
                type: 'line',
                data: {
                    labels: labelsMeses,
                    datasets: [{
                        label: 'Serviços por Mês',
                        data: dadosMeses,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function atualizarTabelaHistorico(servicosFiltrados) {
            const tbody = document.getElementById('tabelaHistorico');
            tbody.innerHTML = '';
            
            servicosFiltrados.forEach(servico => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${servico.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatarDataHora(servico.dataHora)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${servico.origem.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${servico.destino.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${servico.itens.length}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${getStatusText(servico.status, servico)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${servico.divergencias ? servico.divergencias.length : 0}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="verDetalhesServico('${servico.id}')" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function atualizarTopTransportadoras(servicosFiltrados) {
            const container = document.getElementById('topTransportadoras');
            container.innerHTML = '';
            
            const stats = {};
            servicosFiltrados.forEach(s => {
                const t = s.origem;
                if (!stats[t.nome]) {
                    stats[t.nome] = { total: 0, sucesso: 0, divergencias: 0 };
                }
                stats[t.nome].total++;
                if (s.status === 'concluido') stats[t.nome].sucesso++;
                if (s.status === 'divergente' || s.concluido_com_divergencia === true) stats[t.nome].divergencias++;
            });
            
            const ranking = Object.entries(stats)
                .map(([nome, dados]) => ({
                    nome,
                    ...dados,
                    taxa: dados.total > 0 ? Math.round((dados.sucesso / dados.total) * 100) : 0
                }))
                .sort((a, b) => b.taxa - a.taxa)
                .slice(0, 5);
            
            ranking.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-gray-400">#${index + 1}</span>
                        <div>
                            <p class="font-medium text-gray-900">${item.nome}</p>
                            <p class="text-sm text-gray-500">${item.total} serviços</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-green-600">${item.taxa}%</p>
                        <p class="text-xs text-gray-500">sucesso</p>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function atualizarAnaliseDivergencias(servicosFiltrados) {
            const container = document.getElementById('analiseDivergencias');
            container.innerHTML = '';
            
            const servicosDivergentes = servicosFiltrados.filter(s => s.status === 'divergente' || s.concluido_com_divergencia === true);
            const totalDivergencias = servicosDivergentes.reduce((total, s) => total + (s.divergencias ? s.divergencias.length : 0), 0);
            
            const tiposDivergencia = {};
            servicosDivergentes.forEach(s => {
                if (s.divergencias) {
                    s.divergencias.forEach(d => {
                        tiposDivergencia[d.tipo] = (tiposDivergencia[d.tipo] || 0) + 1;
                    });
                }
            });
            
            // Resumo geral
            const resumo = document.createElement('div');
            resumo.className = 'p-4 bg-red-50 rounded-lg border border-red-200';
            resumo.innerHTML = `
                <h4 class="font-semibold text-red-800 mb-2">Resumo de Divergências</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-red-600">Serviços com divergência:</span>
                        <span class="font-bold ml-2">${servicosDivergentes.length}</span>
                    </div>
                    <div>
                        <span class="text-red-600">Total de divergências:</span>
                        <span class="font-bold ml-2">${totalDivergencias}</span>
                    </div>
                </div>
            `;
            container.appendChild(resumo);
            
            // Tipos de divergência
            Object.entries(tiposDivergencia).forEach(([tipo, count]) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <span class="text-sm text-gray-700">${tipo === 'extra' ? 'Itens Extras' : 'Itens Faltando'}</span>
                    <span class="font-bold text-red-600">${count}</span>
                `;
                container.appendChild(div);
            });
        }

        function exportarCSV() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            let servicosExportar = servicos;
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                fim.setHours(23, 59, 59, 999);
                
                servicosExportar = servicos.filter(s => {
                    const dataServico = new Date(s.dataHora);
                    return dataServico >= inicio && dataServico <= fim;
                });
            }
            
            const csvContent = [
                ['ID Serviço', 'Data/Hora', 'Origem', 'Destino', 'Itens', 'Status', 'Divergências', 'Usuário'],
                ...servicosExportar.map(s => [
                    s.id,
                    formatarDataHora(s.dataHora),
                    s.origem.nome,
                    s.destino.nome,
                    s.itens.length,
                    getStatusText(s.status),
                    s.divergencias ? s.divergencias.length : 0,
                    s.usuario
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `relatorio-logitrace-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('Arquivo CSV exportado com sucesso!', 'success');
        }

        function gerarPDFRelatorioCompleto() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Cabeçalho visual marcante
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('LOGITRACE', 15, 18);
            doc.setFontSize(13);
            doc.setFont('helvetica', 'normal');
            doc.text('Relatório Completo de Análises e Divergências', 15, 26);

            // Período e geração
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            doc.setTextColor(55, 65, 81);
            doc.setFontSize(11);
            doc.text(`Período: ${dataInicio || 'Início'} até ${dataFim || 'Hoje'}`, 15, 40);
            doc.text(`Gerado em: ${formatarDataHora(new Date())}`, 15, 46);

            // KPIs - destaque visual
            doc.setFontSize(15);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(37, 99, 235);
            doc.text('INDICADORES PRINCIPAIS', 15, 60);
            doc.setFontSize(10);
            doc.setTextColor(0,0,0);
            const kpis = [
                ['Total de Serviços', document.getElementById('relatorioTotalServicos').textContent],
                ['Taxa de Sucesso', document.getElementById('relatorioTaxaSucesso').textContent],
                ['Divergências', document.getElementById('relatorioTotalDivergencias').textContent],
                ['Tempo Médio', document.getElementById('relatorioTempoMedio').textContent]
            ];
            let yKPI = 66;
            kpis.forEach(([label, value]) => {
                doc.setFont('helvetica', 'normal');
                doc.text(`${label}:`, 20, yKPI);
                doc.setFont('helvetica', 'bold');
                doc.text(value, 70, yKPI);
                yKPI += 7;
            });

            // Resumo geral
            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(37,99,235);
            doc.text('RESUMO GERAL DOS SERVIÇOS', 15, yKPI+8);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            let yResumo = yKPI+14;
            // Tabela de serviços
            doc.setFillColor(220,230,250);
            doc.rect(15, yResumo, 180, 8, 'F');
            doc.setTextColor(37,99,235);
            doc.text('ID', 18, yResumo+6);
            doc.text('Data', 30, yResumo+6);
            doc.text('Origem', 60, yResumo+6);
            doc.text('Destino', 100, yResumo+6);
            doc.text('Status', 140, yResumo+6);
            doc.text('Divergências', 170, yResumo+6);
            doc.setTextColor(0,0,0);
            let yServ = yResumo+10;
            let servicosFiltrados = Array.isArray(window.servicos) ? window.servicos : [];
            if (dataInicio && dataFim) {
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                fim.setHours(23, 59, 59, 999);
                servicosFiltrados = servicosFiltrados.filter(s => {
                    const dataServico = new Date(s.dataHora);
                    return dataServico >= inicio && dataServico <= fim;
                });
            }
            servicosFiltrados.slice(0, 12).forEach(s => {
                doc.text(`${s.id}`, 18, yServ);
                doc.text(`${formatarDataHora(s.dataHora)}`, 30, yServ);
                doc.text(`${s.origem.nome}`, 60, yServ);
                doc.text(`${s.destino.nome}`, 100, yServ);
                doc.text(`${getStatusText(s.status)}`, 140, yServ);
                doc.text(`${(s.divergencias && s.divergencias.length) || 0}`, 170, yServ);
                yServ += 7;
            });
            if (servicosFiltrados.length > 12) {
                doc.setTextColor(120,120,120);
                doc.text(`...e mais ${servicosFiltrados.length-12} serviços`, 18, yServ);
                doc.setTextColor(0,0,0);
            }

            // Lista de divergências detalhada
            yServ += 10;
            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(239,68,68);
            doc.text('DIVERGÊNCIAS ENCONTRADAS', 15, yServ);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0,0,0);
            let yDiv = yServ+6;
            let divergenciasTotais = [];
            servicosFiltrados.forEach(s => {
                // Pega divergências de todas as propriedades possíveis
                let divs = [];
                if (Array.isArray(s.divergencias) && s.divergencias.length > 0) {
                    divs = s.divergencias;
                } else if (Array.isArray(s.concluido_com_divergencia) && s.concluido_com_divergencia.length > 0) {
                    divs = s.concluido_com_divergencia;
                } else if (Array.isArray(s.divergente) && s.divergente.length > 0) {
                    divs = s.divergente;
                }
                // Se o serviço tem status divergente ou concluido_com_divergencia, mas não tem divergências, criar uma divergência genérica
                if (divs.length === 0 && (s.status === 'divergente' || s.concluido_com_divergencia === true)) {
                    divs = [{
                        tipo: 'desconhecido',
                        descricao: 'Divergência registrada, mas detalhes não disponíveis.',
                        servicoId: s.id
                    }];
                }
                if (divs.length > 0) {
                    divergenciasTotais = divergenciasTotais.concat(divs.map(div => ({...div, servicoId: s.id})));
                }
            });
            if (divergenciasTotais.length > 0) {
                doc.setFillColor(255,230,230);
                doc.rect(15, yDiv, 180, 8, 'F');
                doc.setTextColor(239,68,68);
                doc.text('Serviço', 18, yDiv+6);
                doc.text('Código', 40, yDiv+6);
                doc.text('Tipo', 70, yDiv+6);
                doc.text('Descrição', 100, yDiv+6);
                doc.text('Severidade', 170, yDiv+6);
                doc.setTextColor(0,0,0);
                yDiv += 10;
                divergenciasTotais.slice(0, 10).forEach(div => {
                    doc.text(`${div.servicoId}`, 18, yDiv);
                    doc.text(`${div.codigo || div.cod || '-'}`, 40, yDiv);
                    doc.text(`${div.tipo === 'extra' ? 'Item Extra' : div.tipo === 'faltando' ? 'Item Faltando' : (div.tipo || '-')}`, 70, yDiv);
                    doc.text(`${div.descricao || div.observacao || '-'}`, 100, yDiv);
                    doc.text(`${div.severidade || '-'}`, 170, yDiv);
                    yDiv += 7;
                });
                if (divergenciasTotais.length > 10) {
                    doc.setTextColor(120,120,120);
                    doc.text(`...e mais ${divergenciasTotais.length-10} divergências`, 18, yDiv);
                    doc.setTextColor(0,0,0);
                }
            } else {
                doc.setTextColor(120,120,120);
                doc.text('Nenhuma divergência encontrada nos serviços deste período.', 18, yDiv);
                doc.setTextColor(0,0,0);
            }

            // Cláusulas e termos
            let yClausula = Math.max(yDiv+12, 200);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(37,99,235);
            doc.text('CLÁUSULAS E TERMOS', 15, yClausula);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0,0,0);
            doc.text('1. Este relatório detalha todos os serviços realizados e divergências encontradas no período selecionado.', 15, yClausula+7);
            doc.text('2. As partes envolvidas concordam com os dados apresentados e se comprometem a tomar as providências necessárias para resolução das divergências.', 15, yClausula+13);
            doc.text('3. O presente documento serve como registro formal e pode ser utilizado para fins de auditoria e controle interno.', 15, yClausula+19);
            doc.text('4. As assinaturas abaixo confirmam a ciência e concordância das partes envolvidas.', 15, yClausula+25);

            // Espaço para assinaturas
            let yAssinatura = 260;
            // Linhas de assinatura sem texto acima
            doc.setDrawColor(37,99,235);
            doc.line(15, yAssinatura+6, 90, yAssinatura+6);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0,0,0);
            doc.text('(Nome, cargo e assinatura)', 15, yAssinatura+11);

            doc.setDrawColor(37,99,235);
            doc.line(120, yAssinatura+6, 198, yAssinatura+6);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.setTextColor(0,0,0);
            doc.text('(Nome, cargo e assinatura)', 120, yAssinatura+11);

            // Rodapé profissional
            doc.setFontSize(8);
            doc.setTextColor(120,120,120);
            doc.text('Documento gerado automaticamente pelo sistema LogiTrace • www.logitrace.com.br', 15, 292);

            doc.save(`relatorio-completo-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Relatório PDF gerado com sucesso!', 'success');
        }

        // Funções do Modal de Conclusão
        let servicoParaConcluir = null;

        function abrirModalConclusao(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;
            
            servicoParaConcluir = servico;
            
            // Preencher informações do serviço
            const infoContainer = document.getElementById('infoConclusaoServico');
            infoContainer.innerHTML = `
                <div class="text-sm">
                    <p><strong>Serviço:</strong> ${servico.id}</p>
                    <p><strong>Rota:</strong> ${servico.origem.nome} → ${servico.destino.nome}</p>
                    <p><strong>Divergências:</strong> ${servico.divergencias ? servico.divergencias.length : 0} item(ns)</p>
                    <p><strong>Data:</strong> ${formatarDataHora(servico.dataHora)}</p>
                </div>
            `;
            
            // Limpar comentário anterior
            document.getElementById('comentarioConclusao').value = '';
            
            // Mostrar modal
            document.getElementById('modalConclusao').classList.remove('hidden');
            document.getElementById('comentarioConclusao').focus();
        }

        function fecharModalConclusao() {
            document.getElementById('modalConclusao').classList.add('hidden');
            servicoParaConcluir = null;
            document.getElementById('comentarioConclusao').value = '';
        }

        function confirmarConclusaoComDivergencia() {
            const comentario = document.getElementById('comentarioConclusao').value.trim();
            
            if (!currentUser) {
                const usuarioSalvo = localStorage.getItem('logitrace_user');
                if (usuarioSalvo) {
                    currentUser = JSON.parse(usuarioSalvo);
                }
            }
            if (currentUser) {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = currentUser.nome || '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = currentUser.email || '';
                }
            } else {
                if (document.getElementById('perfilNome')) {
                    document.getElementById('perfilNome').textContent = '';
                }
                if (document.getElementById('perfilEmail')) {
                    document.getElementById('perfilEmail').textContent = '';
                }
            }
            // Removido bloco solto e fechamento incorreto

                // Atualizar objeto local
                servicoParaConcluir.status = 'concluido';
                servicoParaConcluir.progresso = 100;
                servicoParaConcluir.dataFinalizacao = dataFinalizacao;
                servicoParaConcluir.comentarioConclusao = comentario;
                servicoParaConcluir.concluido_com_divergencia = true;
                // NÃO remover divergências do serviço!
                // servicoParaConcluir.divergencias deve continuar existindo para visualização futura

                // Salvar referência antes de fechar o modal
                const servicoFinalizado = servicoParaConcluir;

                // Adicionar atividade
                atividades.push({
                    id: Date.now(),
                    descricao: `Serviço ${servicoFinalizado.id} concluído com divergências por ${currentUser.nome}`,
                    dataHora: new Date(),
                    icone: 'fa-check-circle',
                    usuario: currentUser.nome
                });

                // Fechar todos os modais (inclusive backdrop)
                document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.add('hidden'));
                fecharModalConclusao();

                // Atualizar interface
                carregarServicosSupabase().then(() => {
                    atualizarDashboard();
                });

                showNotification(`Serviço ${servicoFinalizado.id} concluído com sucesso!`, 'success');

                // Simular notificação colaborativa
                setTimeout(() => {
                    simularAtualizacaoColaborativa(`Serviço ${servicoFinalizado.id} concluído com divergências`, 'info');
                }, 1000);
            }
        

        // Função para excluir serviço
        function excluirServico(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;
            
            // Só permite excluir serviços pendentes
            if (servico.status !== 'pendente') {
                showNotification('Só é possível excluir serviços pendentes!', 'warning');
                return;
            }
            
            // Criar modal de confirmação personalizado
            const modalConfirmacao = document.createElement('div');
            modalConfirmacao.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50';
            modalConfirmacao.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="bg-red-100 p-3 rounded-full mr-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Confirmar Exclusão</h3>
                                    <p class="text-sm text-gray-600">Esta ação não pode ser desfeita</p>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <p class="text-gray-700">
                                    Tem certeza que deseja excluir o serviço <strong>${servicoId}</strong>?
                                </p>
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600">
                                        <strong>Origem:</strong> ${servico.origem.nome}<br>
                                        <strong>Destino:</strong> ${servico.destino.nome}<br>
                                        <strong>Itens:</strong> ${servico.itens.length}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button onclick="confirmarExclusaoServico('${servicoId}'); this.closest('.modal-backdrop').remove();" 
                                        class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-all font-medium">
                                    <i class="fas fa-trash mr-2"></i>Sim, Excluir
                                </button>
                                <button onclick="this.closest('.modal-backdrop').remove();" 
                                        class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-all font-medium">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalConfirmacao);
        }
        
        async function confirmarExclusaoServico(servicoId) {
            // Remover serviço do Supabase
            try {
                const { error, data } = await supabaseClient
                    .from('servicos')
                    .delete()
                    .eq('id', servicoId);
                if (error) {
                    console.error('Erro ao excluir serviço no Supabase:', error, 'ID:', servicoId);
                    showNotification('Erro ao excluir serviço: ' + error.message, 'error');
                    return;
                }
                if (data && data.length === 0) {
                    showNotification('Nenhum serviço foi excluído. Verifique se o ID está correto.', 'warning');
                }
            } catch (e) {
                console.error('Exceção ao tentar excluir serviço:', e);
                showNotification('Erro inesperado ao excluir serviço.', 'error');
                return;
            }
            // Remover da lista local
            const index = servicos.findIndex(s => s.id === servicoId);
            if (index > -1) {
                servicos.splice(index, 1);
            }
            // Adicionar atividade
            atividades.push({
                id: Date.now(),
                descricao: `Serviço ${servicoId} excluído por ${currentUser.nome}`,
                dataHora: new Date(),
                icone: 'fa-trash',
                usuario: currentUser.nome
            });
            // Adicionar notificação do sistema para todos do grupo
            await adicionarNotificacaoSistema(
                currentUser.grupo_id,
                `Serviço excluído: ${servicoId} por ${currentUser.nome}`,
                'servico_excluido'
            );
            // Fechar todos os modais de detalhes de serviço abertos (podem haver vários)
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                // Só remove se for modal de detalhes criado dinamicamente (não os fixos do sistema)
                if (!modal.id || modal.id === '' || modal.id === undefined) {
                    modal.remove();
                }
            });
            // Modal de conferência
            // Fechar modal de conferência se estiver aberto
            const modalConferenciaEl = document.getElementById('modalConferencia');
            if (modalConferenciaEl) {
                modalConferenciaEl.classList.add('hidden');
            }
            // Fechar modal de conclusão se estiver aberto
            const modalConclusaoEl = document.getElementById('modalConclusao');
            if (modalConclusaoEl) {
                modalConclusaoEl.classList.add('hidden');
            }
            // Modal de conferência
            const modalConferencia = document.getElementById('modalConferencia');
            if (modalConferencia) {
                modalConferencia.classList.add('hidden');
            }
            // Modal de conclusão
            const modalConclusao = document.getElementById('modalConclusao');
            if (modalConclusao) {
                modalConclusao.classList.add('hidden');
            }
            // Atualizar interface
            await carregarServicosSupabase();
            atualizarDashboard();
            showNotification(`Serviço ${servicoId} excluído com sucesso!`, 'success');
        }

        // Funções Utilitárias
        function formatarDataHora(data) {
            return new Date(data).toLocaleString('pt-BR');
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'andamento': 'Em Andamento',
                'concluido': 'Concluído',
                'divergente': 'Divergente'
            };
            // Se for concluído com divergência, mostrar ambos
            // Aceita segundo argumento opcional: servico
            if (arguments.length > 1) {
                const servico = arguments[1];
                // Se for concluído com divergência, mostrar ambos
                if (servico && servico.status === 'concluido' && (servico.concluido_com_divergencia || servico.concluidoComDivergencia || (servico.divergencias && servico.divergencias.length > 0))) {
                    return `<span class='px-2 py-1 rounded-full text-xs font-medium status-concluido mr-1'>Concluído</span><span class='px-2 py-1 rounded-full text-xs font-medium status-divergente ml-1'>Divergente</span>`;
                }
                if (servico && servico.status === 'concluido') {
                    return `<span class='px-2 py-1 rounded-full text-xs font-medium status-concluido'>Concluído</span>`;
                }
                if (servico && servico.status === 'divergente') {
                    return `<span class='px-2 py-1 rounded-full text-xs font-medium status-divergente'>Divergente</span>`;
                }
            }
            return statusMap[status] || status;
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function calcularTempoMedio() {
            const servicosFinalizados = servicos.filter(s => s.dataFinalizacao);
            if (servicosFinalizados.length === 0) return 0;
            
            const tempoTotal = servicosFinalizados.reduce((total, servico) => {
                const tempo = (new Date(servico.dataFinalizacao) - new Date(servico.dataHora)) / (1000 * 60);
                return total + tempo;
            }, 0);
            
            return Math.round(tempoTotal / servicosFinalizados.length);
        }

        function calcularEstatisticasTempo() {
            const servicosFinalizados = servicos.filter(s => s.dataFinalizacao);
            if (servicosFinalizados.length === 0) return { medio: 0, minimo: 0, maximo: 0, rapidos: 0, lentos: 0 };
            
            const tempos = servicosFinalizados.map(s => (new Date(s.dataFinalizacao) - new Date(s.dataHora)) / (1000 * 60));
            
            return {
                medio: Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length),
                minimo: Math.round(Math.min(...tempos)),
                maximo: Math.round(Math.max(...tempos)),
                rapidos: tempos.filter(t => t < 30).length,
                lentos: tempos.filter(t => t > 60).length,
                total: tempos.length
            };
        }

        function calcularTaxaSucesso() {
            if (servicos.length === 0) return 0;
            const concluidos = servicos.filter(s => s.status === 'concluido').length;
            return Math.round((concluidos / servicos.length) * 100);
        }

        function calcularEficienciaHoraria() {
            const hoje = new Date();
            const servicosHoje = servicos.filter(s => isToday(new Date(s.dataHora)));
            
            const porHora = {};
            for (let h = 0; h < 24; h++) {
                porHora[h] = 0;
            }
            
            servicosHoje.forEach(s => {
                const hora = new Date(s.dataHora).getHours();
                porHora[hora]++;
            });
            
            return porHora;
        }

        function getWeekKey(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - startOfYear) / 86400000;
            const weekNumber = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
            return `${date.getFullYear()}-S${weekNumber}`;
        }

        function simularAtualizacaoTempoReal() {
            // Simular mudanças de status aleatórias
            const servicosPendentes = servicos.filter(s => s.status === 'andamento');
            if (servicosPendentes.length > 0 && Math.random() > 0.7) {
                const servico = servicosPendentes[Math.floor(Math.random() * servicosPendentes.length)];
                servico.progresso = Math.min(servico.progresso + Math.floor(Math.random() * 20), 100);
                
                if (servico.progresso >= 100) {
                    // Simular tempo de processamento realista
                    const tempoProcessamento = Math.random() * 90 + 15; // 15-105 minutos
                    const dataFinalizacao = new Date(new Date(servico.dataHora).getTime() + tempoProcessamento * 60000);
                    
                    servico.status = Math.random() > 0.85 ? 'divergente' : 'concluido';
                    servico.dataFinalizacao = dataFinalizacao;
                    
                    // Se divergente, adicionar divergências simuladas
                    if (servico.status === 'divergente') {
                        servico.divergencias = [];
                        const numDivergencias = Math.floor(Math.random() * 3) + 1;
                        
                        for (let i = 0; i < numDivergencias; i++) {
                            const tipo = Math.random() > 0.5 ? 'extra' : 'faltando';
                            servico.divergencias.push({
                                tipo: tipo,
                                codigo: 'SIM' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                                descricao: tipo === 'extra' ? 'Item extra encontrado na conferência' : 'Item não encontrado na conferência',
                                severidade: Math.random() > 0.5 ? 'critica' : 'media'
                            });
                        }
                    }
                    
                    atividades.push({
                        id: Date.now(),
                        descricao: `Serviço ${servico.id} finalizado - ${getStatusText(servico.status)} (${Math.round(tempoProcessamento)}min)`,
                        dataHora: dataFinalizacao,
                        icone: servico.status === 'concluido' ? 'fa-check' : 'fa-exclamation-triangle',
                        usuario: 'Sistema'
                    });
                }
                
                atualizarDashboard();
                carregarServicos();
            }
        }

        function simularAtualizacaoColaborativa(mensagem, tipo) {
            showNotification(`🔄 ${mensagem}`, tipo);
        }

        // Funções de Transportadora
        function mostrarModalTransportadora() {
            document.getElementById('modalTransportadora').classList.remove('hidden');
            document.getElementById('nomeTransportadora').focus();
        }

        function fecharModalTransportadora() {
            document.getElementById('modalTransportadora').classList.add('hidden');
            document.getElementById('formTransportadora').reset();
        }

        function cadastrarTransportadora() {
            const nome = document.getElementById('nomeTransportadora').value.trim();
            const cnpj = document.getElementById('cnpjTransportadora').value.trim();
            const telefone = document.getElementById('telefoneTransportadora').value.trim();
            const email = document.getElementById('emailTransportadora').value.trim();
            const endereco = document.getElementById('enderecoTransportadora').value.trim();

            if (!nome || !cnpj) {
                showNotification('Nome e CNPJ são obrigatórios!', 'warning');
                return;
            }

            // Verificar se CNPJ já existe
            if (transportadoras.some(t => t.cnpj === cnpj)) {
                showNotification('CNPJ já cadastrado!', 'warning');
                return;
            }

            const novaTransportadora = {
                id: Date.now(),
                nome: nome,
                cnpj: cnpj,
                telefone: telefone,
                email: email,
                endereco: endereco,
                status: 'ativo'
            };

            transportadoras.push(novaTransportadora);

            // Adicionar atividade
            atividades.push({
                id: Date.now(),
                descricao: `Transportadora ${nome} cadastrada por ${currentUser.nome}`,
                dataHora: new Date(),
                icone: 'fa-building',
                usuario: currentUser.nome
            });

            fecharModalTransportadora();
            carregarSelectsTransportadoras();
            atualizarDashboard();
            
            showNotification('Transportadora cadastrada com sucesso!', 'success');
        }

        // Event Listeners

            // Verificar se há usuário logado
            if (!verificarUsuarioLogado()) {
                // Se não há usuário logado, mostrar tela de login
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainSystem').classList.add('hidden');
            }
            
            // Configurar enter no campo de código de barras
            document.getElementById('codigoBarras').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    adicionarItem();
                }
            });
            
            // Configurar enter no campo de conferência
            document.getElementById('codigoConferencia').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    conferirItem();
                }
            });
            
            // Fechar modal ao clicar fora
            document.getElementById('modalConferencia').addEventListener('click', function(e) {
                if (e.target === this) {
                    fecharModalConferencia();
                }
            });
            
            // Configurar Ctrl+Enter no textarea de comentário
            document.getElementById('comentarioConclusao').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    confirmarConclusaoComDivergencia();
                }
            });
            
            // Form de transportadora
            document.getElementById('formTransportadora').addEventListener('submit', function(e) {
                e.preventDefault();
                cadastrarTransportadora();
            });
            // Garante que os botões estão ligados às funções corretas
            // Adicionar Item
            const btnAdicionarItem = document.getElementById('btnAdicionarItem');
            if (btnAdicionarItem) {
                btnAdicionarItem.addEventListener('click', adicionarItem);
                console.log('Listener de adicionarItem configurado');
            }
            // Criar Serviço
            const btnCriarServico = document.getElementById('btnCriarServico');
            if (btnCriarServico) {
                btnCriarServico.addEventListener('click', criarServico);
                console.log('Listener de criarServico configurado');
            }
            // Remover Item (delegação para lista)
            const listaItens = document.getElementById('listaItens');
            if (listaItens) {
                listaItens.addEventListener('click', function(e) {
                    const btn = e.target.closest('button');
                    if (btn && btn.classList.contains('text-red-600')) {
                        const id = parseInt(btn.getAttribute('data-id'));
                        if (!isNaN(id)) {
                            removerItem(id);
                        }
                    }
                });
                console.log('Listener de removerItem configurado');
            }

        // Função para abrir modais dos KPIs
        function abrirModalKPI(tipo) {
            let titulo, conteudo, dados;
            
            switch(tipo) {
                case 'servicos-ativos':
                    titulo = 'Serviços Ativos';
                    dados = servicos.filter(s => s.status === 'pendente' || s.status === 'andamento');
                    conteudo = gerarConteudoServicosAtivos(dados);
                    break;
                    
                case 'concluidos-hoje':
                    titulo = 'Serviços Concluídos Hoje';
                    dados = servicos.filter(s => s.status === 'concluido' && isToday(new Date(s.dataHora)));
                    conteudo = gerarConteudoConcluidos(dados);
                    break;
                    
                case 'divergencias':
                    titulo = 'Análise de Divergências';
                    dados = servicos.filter(s => s.status === 'divergente');
                    conteudo = gerarConteudoDivergencias(dados);
                    break;
                    
                case 'tempo-medio':
                    titulo = 'Análise de Performance';
                    dados = servicos.filter(s => s.dataFinalizacao);
                    conteudo = gerarConteudoTempoMedio(dados);
                    break;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-screen overflow-y-auto">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-2xl font-bold text-gray-900">${titulo}</h3>
                                <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            ${conteudo}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Renderizar gráficos após o modal ser adicionado ao DOM
            // Tenta renderizar até o canvas aparecer (máx 1s)
            let tentativas = 0;
            function tentarRenderizarGrafico() {
                tentativas++;
                const canvas = document.getElementById('modalChart');
                console.log('[ModalKPI] Tentando renderizar gráfico, tentativa', tentativas, 'canvas:', !!canvas, 'tipo:', tipo, 'dados:', dados);
                if (canvas) {
                    renderizarGraficosModal(tipo, dados);
                } else if (tentativas < 10) {
                    setTimeout(tentarRenderizarGrafico, 100);
                } else {
                    console.warn('[ModalKPI] Não foi possível encontrar o canvas para o gráfico do modal após 1s.');
                }
            }
            setTimeout(tentarRenderizarGrafico, 100);
        }

        function gerarConteudoServicosAtivos(dados) {
            const pendentes = dados.filter(s => s.status === 'pendente').length;
            const andamento = dados.filter(s => s.status === 'andamento').length;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-blue-800">Distribuição por Status</h4>
                            <i class="fas fa-chart-pie text-blue-600 text-2xl"></i>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-700">Pendentes:</span>
                                <span class="font-bold text-blue-900">${pendentes}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-blue-700">Em Andamento:</span>
                                <span class="font-bold text-blue-900">${andamento}</span>
                            </div>
                            <div class="flex justify-between items-center border-t pt-2">
                                <span class="text-blue-700 font-semibold">Total:</span>
                                <span class="font-bold text-blue-900 text-xl">${dados.length}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="h-64">
                        <canvas id="modalChart"></canvas>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Lista de Serviços Ativos</h4>
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        ${dados.map(servico => `
                            <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-900">${servico.id}</p>
                                    <p class="text-sm text-gray-600">${servico.origem.nome} → ${servico.destino.nome}</p>
                                    <p class="text-xs text-gray-500">${formatarDataHora(servico.dataHora)}</p>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 rounded-full text-xs font-medium status-${servico.status}">
                                        ${getStatusText(servico.status, servico)}
                                    </span>
                                    ${servico.status === 'andamento' ? `
                                        <div class="mt-2">
                                            <div class="bg-gray-200 rounded-full h-2 w-20">
                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${servico.progresso}%"></div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function gerarConteudoConcluidos(dados) {
            const totalItens = dados.reduce((total, s) => total + s.itens.length, 0);
            const tempoMedio = dados.length > 0 ? Math.round(dados.reduce((total, s) => {
                const tempo = (new Date(s.dataFinalizacao) - new Date(s.dataHora)) / (1000 * 60);
                return total + tempo;
            }, 0) / dados.length) : 0;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl text-center">
                        <i class="fas fa-check-circle text-green-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-green-800">${dados.length}</p>
                        <p class="text-green-700">Serviços Concluídos</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl text-center">
                        <i class="fas fa-boxes text-blue-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-blue-800">${totalItens}</p>
                        <p class="text-blue-700">Itens Processados</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl text-center">
                        <i class="fas fa-clock text-purple-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-purple-800">${tempoMedio}min</p>
                        <p class="text-purple-700">Tempo Médio</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="h-64">
                        <canvas id="modalChart"></canvas>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Serviços Concluídos Hoje</h4>
                        <div class="space-y-3 max-h-48 overflow-y-auto">
                            ${dados.map(servico => `
                                <div class="bg-white p-3 rounded-lg border">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-gray-900">${servico.id}</p>
                                            <p class="text-sm text-gray-600">${servico.origem.nome} → ${servico.destino.nome}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs text-gray-500">${formatarDataHora(servico.dataFinalizacao)}</p>
                                            <p class="text-xs text-green-600 font-medium">${servico.itens.length} itens</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarConteudoDivergencias(dados) {
            const totalDivergencias = dados.reduce((total, s) => total + (s.divergencias ? s.divergencias.length : 0), 0);
            const extras = dados.reduce((total, s) => total + (s.divergencias ? s.divergencias.filter(d => d.tipo === 'extra').length : 0), 0);
            const faltando = dados.reduce((total, s) => total + (s.divergencias ? s.divergencias.filter(d => d.tipo === 'faltando').length : 0), 0);
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl text-center">
                        <i class="fas fa-exclamation-triangle text-red-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-red-800">${dados.length}</p>
                        <p class="text-red-700">Serviços com Divergência</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl text-center">
                        <i class="fas fa-list text-orange-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-orange-800">${totalDivergencias}</p>
                        <p class="text-orange-700">Total de Divergências</p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl text-center">
                        <i class="fas fa-plus text-yellow-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-yellow-800">${extras}</p>
                        <p class="text-yellow-700">Itens Extras</p>
                    </div>
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl text-center">
                        <i class="fas fa-minus text-gray-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-gray-800">${faltando}</p>
                        <p class="text-gray-700">Itens Faltando</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="h-64">
                        <canvas id="modalChart"></canvas>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Serviços com Divergências</h4>
                        <div class="space-y-3 max-h-48 overflow-y-auto">
                            ${dados.map(servico => `
                                <div class="bg-white p-3 rounded-lg border border-red-200">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-gray-900">${servico.id}</p>
                                            <p class="text-sm text-gray-600">${servico.origem.nome} → ${servico.destino.nome}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs text-red-600 font-medium">${servico.divergencias ? servico.divergencias.length : 0} divergências</p>
                                            <button onclick="verDetalhesServico('${servico.id}'); this.closest('.modal-backdrop').remove();" class="text-xs text-blue-600 hover:text-blue-800 mt-1">
                                                Ver detalhes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function gerarConteudoTempoMedio(dados) {
            const tempos = dados.filter(s => s.status === 'concluido' && s.dataFinalizacao).map(s => {
                return (new Date(s.dataFinalizacao) - new Date(s.dataHora)) / (1000 * 60);
            });
            let tempoMedio = 0, tempoMinimo = 0, tempoMaximo = 0;
            if (tempos.length > 0) {
                tempoMedio = Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length);
                tempoMinimo = Math.round(Math.min(...tempos));
                tempoMaximo = Math.round(Math.max(...tempos));
            }
            if (!isFinite(tempoMedio) || isNaN(tempoMedio)) tempoMedio = 0;
            if (!isFinite(tempoMinimo) || isNaN(tempoMinimo)) tempoMinimo = 0;
            if (!isFinite(tempoMaximo) || isNaN(tempoMaximo)) tempoMaximo = 0;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl text-center">
                        <i class="fas fa-tachometer-alt text-green-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-green-800">${tempoMinimo}min</p>
                        <p class="text-green-700">Tempo Mínimo</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl text-center">
                        <i class="fas fa-clock text-blue-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-blue-800">${tempoMedio}min</p>
                        <p class="text-blue-700">Tempo Médio</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl text-center">
                        <i class="fas fa-hourglass-end text-red-600 text-3xl mb-3"></i>
                        <p class="text-2xl font-bold text-red-800">${tempoMaximo}min</p>
                        <p class="text-red-700">Tempo Máximo</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="h-64">
                        <canvas id="modalChart"></canvas>
                    </div>
                    
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Análise de Performance</h4>
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-600">Serviços Rápidos (< 30min)</span>
                                    <span class="font-bold text-green-600">${tempos.filter(t => t < 30).length}</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${(tempos.filter(t => t < 30).length / tempos.length) * 100}%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-600">Serviços Normais (30-60min)</span>
                                    <span class="font-bold text-blue-600">${tempos.filter(t => t >= 30 && t <= 60).length}</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${(tempos.filter(t => t >= 30 && t <= 60).length / tempos.length) * 100}%"></div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-600">Serviços Lentos (> 60min)</span>
                                    <span class="font-bold text-red-600">${tempos.filter(t => t > 60).length}</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: ${(tempos.filter(t => t > 60).length / tempos.length) * 100}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderizarGraficosModal(tipo, dados) {
            const canvas = document.getElementById('modalChart');
            if (!canvas) {
                console.error('[ModalKPI] Canvas do gráfico não encontrado! tipo:', tipo, 'dados:', dados);
                return;
            }
            // Garante altura mínima
            canvas.height = canvas.height || 256;
            const ctx = canvas.getContext('2d');
            // Destruir gráfico existente se houver
            if (window.modalChartInstance) {
                window.modalChartInstance.destroy();
            }
            console.log('[ModalKPI] Renderizando gráfico tipo', tipo, 'com', dados.length, 'dados');
            
            switch(tipo) {
                case 'servicos-ativos':
                    const pendentes = dados.filter(s => s.status === 'pendente').length;
                    const andamento = dados.filter(s => s.status === 'andamento').length;
                    
                    window.modalChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Pendentes', 'Em Andamento'],
                            datasets: [{
                                data: [pendentes, andamento],
                                backgroundColor: ['#fbbf24', '#3b82f6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    break;
                    
                case 'concluidos-hoje':
                    // Gráfico de barras por hora
                    const horas = {};
                    dados.forEach(s => {
                        const hora = new Date(s.dataFinalizacao).getHours();
                        horas[hora] = (horas[hora] || 0) + 1;
                    });
                    
                    const horasLabels = Object.keys(horas).sort((a, b) => a - b);
                    const horasDados = horasLabels.map(h => horas[h]);
                    
                    window.modalChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: horasLabels.map(h => h + 'h'),
                            datasets: [{
                                label: 'Serviços Concluídos',
                                data: horasDados,
                                backgroundColor: '#10b981'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    break;
                    
                case 'divergencias':
                    const extras = dados.reduce((total, s) => total + (s.divergencias ? s.divergencias.filter(d => d.tipo === 'extra').length : 0), 0);
                    const faltando = dados.reduce((total, s) => total + (s.divergencias ? s.divergencias.filter(d => d.tipo === 'faltando').length : 0), 0);
                    
                    window.modalChartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Itens Extras', 'Itens Faltando'],
                            datasets: [{
                                data: [extras, faltando],
                                backgroundColor: ['#f59e0b', '#ef4444']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    break;
                    
                case 'tempo-medio':
                    // Histograma de tempos
                    const tempos = dados.map(s => (new Date(s.dataFinalizacao) - new Date(s.dataHora)) / (1000 * 60));
                    const faixas = ['0-15min', '15-30min', '30-45min', '45-60min', '60+min'];
                    const contadores = [
                        tempos.filter(t => t < 15).length,
                        tempos.filter(t => t >= 15 && t < 30).length,
                        tempos.filter(t => t >= 30 && t < 45).length,
                        tempos.filter(t => t >= 45 && t < 60).length,
                        tempos.filter(t => t >= 60).length
                    ];
                    
                    window.modalChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: faixas,
                            datasets: [{
                                label: 'Número de Serviços',
                                data: contadores,
                                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    break;
            }
        }

        // Funções Mobile
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.classList.add('show'), 10);
                setTimeout(() => {
                    document.addEventListener('click', fecharMenuMobile);
                }, 100);
            } else {
                menu.classList.remove('show');
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
                document.removeEventListener('click', fecharMenuMobile);
            }
        }

        function fecharMenuMobile(event) {
            const menu = document.getElementById('mobileMenu');
            const button = event.target.closest('button[onclick="toggleMobileMenu()"]');
            if (!menu.contains(event.target) && !button) {
                menu.classList.remove('show');
                setTimeout(() => {
                    menu.classList.add('hidden');
                }, 300);
                document.removeEventListener('click', fecharMenuMobile);
            }
        }

        function toggleMobileActionsMenu() {
            const menu = document.getElementById('mobileActionsMenu');
            const icon = document.getElementById('centralActionIcon');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('show');
                icon.className = 'fas fa-times text-xl';
                
                // Atualizar status no menu
                atualizarStatusMobile();
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('show');
                icon.className = 'fas fa-plus text-xl';
            }
        }

        function atualizarStatusMobile() {
            const servicosAtivos = servicos.filter(s => s.status === 'pendente' || s.status === 'andamento').length;
            const concluidosHoje = servicos.filter(s => s.status === 'concluido' && isToday(new Date(s.dataHora))).length;
            const divergencias = servicos.filter(s => s.status === 'divergente').length;
            
            // Atualizar central de ações
            const mobileStatusAtivos = document.getElementById('mobileStatusAtivos');
            const mobileStatusConcluidos = document.getElementById('mobileStatusConcluidos');
            const mobileStatusDivergencias = document.getElementById('mobileStatusDivergencias');
            
            if (mobileStatusAtivos) mobileStatusAtivos.textContent = servicosAtivos;
            if (mobileStatusConcluidos) mobileStatusConcluidos.textContent = concluidosHoje;
            if (mobileStatusDivergencias) mobileStatusDivergencias.textContent = divergencias;
            
            // Atualizar menu lateral
            const mobileQuickStatsAtivos = document.getElementById('mobileQuickStatsAtivos');
            const mobileQuickStatsHoje = document.getElementById('mobileQuickStatsHoje');
            
            if (mobileQuickStatsAtivos) mobileQuickStatsAtivos.textContent = servicosAtivos;
            if (mobileQuickStatsHoje) mobileQuickStatsHoje.textContent = concluidosHoje;
            
            // Atualizar badges
            const servicosComDivergencia = servicos.filter(s => s.status === 'divergente').length;
            const badgeServicos = document.getElementById('mobileServicosBadge');
            if (badgeServicos) {
                if (servicosComDivergencia > 0) {
                    badgeServicos.textContent = servicosComDivergencia;
                    badgeServicos.classList.remove('hidden');
                } else {
                    badgeServicos.classList.add('hidden');
                }
            }
            
            // Sincronizar badge de notificações mobile
            const naoLidas = notificacoesSistema.filter(n => !n.lida).length;
            const mobileNotifBadge = document.getElementById('mobileNotificationBadge');
            const mobileMenuNotifBadge = document.getElementById('mobileMenuNotificationBadge');
            
            if (mobileNotifBadge) {
                if (naoLidas > 0) {
                    mobileNotifBadge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                    mobileNotifBadge.classList.remove('hidden');
                } else {
                    mobileNotifBadge.classList.add('hidden');
                }
            }
            
            if (mobileMenuNotifBadge) {
                if (naoLidas > 0) {
                    mobileMenuNotifBadge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                    mobileMenuNotifBadge.classList.remove('hidden');
                } else {
                    mobileMenuNotifBadge.classList.add('hidden');
                }
            }
        }

        function atualizarNavegacaoMobile(secaoAtiva) {
            // Remover active de todos os botões mobile
            document.querySelectorAll('.mobile-nav-item:not(.central-action)').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ativar botão correspondente
            const mobileBtn = document.getElementById(`mobileBtn${secaoAtiva.charAt(0).toUpperCase() + secaoAtiva.slice(1)}`);
            if (mobileBtn) {
                mobileBtn.classList.add('active');
            }
        }

        function abrirConferenciaRapida() {
            const servicosPendentes = servicos.filter(s => s.status === 'pendente');
            
            if (servicosPendentes.length === 0) {
                showNotification('Nenhum serviço pendente para conferência!', 'warning');
                return;
            }
            
            // Abrir modal de seleção de serviço
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
                        <div class="p-6 border-b">
                            <h3 class="text-xl font-bold text-gray-900">Conferência Rápida</h3>
                            <p class="text-gray-600 mt-1">Selecione um serviço para iniciar</p>
                        </div>
                        
                        <div class="p-6 max-h-96 overflow-y-auto">
                            ${servicosPendentes.map(servico => `
                                <button onclick="iniciarConferencia('${servico.id}'); this.closest('.modal-backdrop').remove(); toggleMobileActionsMenu();" 
                                        class="w-full p-4 mb-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors text-left">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-semibold text-gray-900">${servico.id}</p>
                                            <p class="text-sm text-gray-600">${servico.origem.nome} → ${servico.destino.nome}</p>
                                            <p class="text-xs text-gray-500">${servico.itens.length} itens</p>
                                        </div>
                                        <i class="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="p-6 border-t">
                            <button onclick="this.closest('.modal-backdrop').remove()" 
                                    class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-all">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function abrirBuscaServico() {
            const searchInput = document.getElementById('mobileSearchInput');
            searchInput.focus();
            
            // Implementar busca em tempo real
            searchInput.oninput = function() {
                const termo = this.value.toLowerCase();
                if (termo.length < 2) return;
                
                const resultados = servicos.filter(s => 
                    s.id.toLowerCase().includes(termo) ||
                    s.origem.nome.toLowerCase().includes(termo) ||
                    s.destino.nome.toLowerCase().includes(termo)
                );
                
                if (resultados.length > 0) {
                    showNotification(`${resultados.length} serviço(s) encontrado(s)`, 'info');
                    // Aqui você pode mostrar os resultados em uma lista
                }
            };
        }

    // PDF generation functions removed as requested


        // Atualizar função de inicialização para mobile
        const originalInicializarSistema = inicializarSistema;
        inicializarSistema = function() {
            originalInicializarSistema();
            
            // Configurar dados mobile
            const mobileCurrentUser = document.getElementById('mobileCurrentUser');
            if (mobileCurrentUser && currentUser) {
                mobileCurrentUser.textContent = currentUser.nome;
            }
            atualizarStatusMobile();
            
            // Configurar navegação mobile inicial
            atualizarNavegacaoMobile('dashboard');
        };

        // Atualizar dashboard para mobile também
        const originalAtualizarDashboard = atualizarDashboard;
        atualizarDashboard = function() {
            originalAtualizarDashboard();
            atualizarStatusMobile();
        };

        // Sistema iniciado sem dados de exemplo
    </script>
</body>
</html>
